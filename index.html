
<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Soul Spark (Final)</title>
    <!-- Cloudinary Upload Widget Script -->
    <script src="https://upload-widget.cloudinary.com/global/all.js" type="text/javascript"></script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;700&family=Dancing+Script:wght@700&family=Caveat:wght@700&display=swap" rel="stylesheet">

<style>
    /* ... (आपका सारा <style> सेक्शन वैसा ही रहेगा) ... */
    :root{--primary-bg:#121212;--secondary-bg:#1e1e1e;--card-bg:#2a2a2a;--text-primary:#e0e0e0;--text-secondary:#b0b0b0;--accent-color:#e91e63;--accent-dark:#c2185b;--success-color:#4CAF50;--error-color:#f44336;--font-family:'Poppins',-apple-system,BlinkMacSystem-Font,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;--neon-glow:none}.theme-neon-blue{--primary-bg:#0d0d0d;--secondary-bg:#1a1a1a;--card-bg:#222;--accent-color:#00BFFF;--accent-dark:#009ACD;--neon-glow:0 0 5px #fff,0 0 10px #fff,0 0 15px var(--accent-color)}.theme-neon-pink{--primary-bg:#0d0d0d;--secondary-bg:#1a1a1a;--card-bg:#222;--accent-color:#FF00FF;--accent-dark:#D900D9;--neon-glow:0 0 5px #fff,0 0 10px #fff,0 0 15px var(--accent-color)}.theme-neon-green{--primary-bg:#0d0d0d;--secondary-bg:#1a1a1a;--card-bg:#222;--accent-color:#39FF14;--accent-dark:#2ECC0F;--neon-glow:0 0 5px #fff,0 0 10px #fff,0 0 15px var(--accent-color)}.theme-neon-red{--primary-bg:#0d0d0d;--secondary-bg:#1a1a1a;--card-bg:#222;--accent-color:#FF3131;--accent-dark:#D92B2B;--neon-glow:0 0 5px #fff,0 0 10px #fff,0 0 15px var(--accent-color)}.theme-neon-orange{--primary-bg:#0d0d0d;--secondary-bg:#1a1a1a;--card-bg:#222;--accent-color:#FFAC1C;--accent-dark:#D99216;--neon-glow:0 0 5px #fff,0 0 10px #fff,0 0 15px var(--accent-color)}.theme-neon-purple{--primary-bg:#0d0d0d;--secondary-bg:#1a1a1a;--card-bg:#222;--accent-color:#BF40BF;--accent-dark:#A336A3;--neon-glow:0 0 5px #fff,0 0 10px #fff,0 0 15px var(--accent-color)}.theme-neon-cyan{--primary-bg:#0d0d0d;--secondary-bg:#1a1a1a;--card-bg:#222;--accent-color:#00FFFF;--accent-dark:#00D9D9;--neon-glow:0 0 5px #fff,0 0 10px #fff,0 0 15px var(--accent-color)}.theme-neon-yellow{--primary-bg:#0d0d0d;--secondary-bg:#1a1a1a;--card-bg:#222;--accent-color:#FFFF00;--accent-dark:#D9D900;--neon-glow:0 0 5px #fff,0 0 10px #fff,0 0 15px var(--accent-color)}.theme-futuristic{--primary-bg:#0d0d0d;--secondary-bg:#1a1a1a;--card-bg:#222;--accent-color:#00ffff;--accent-dark:#00c0c0;--neon-glow:0 0 5px #fff,0 0 10px #fff,0 0 15px var(--accent-color)}.theme-pink-white{--primary-bg:#fff;--secondary-bg:#fce4ec;--card-bg:#fff;--text-primary:#333;--text-secondary:#555;--accent-color:#e91e63;--neon-glow:none}.theme-green-white{--primary-bg:#f7fcf8;--secondary-bg:#e8f5e9;--card-bg:#fff;--text-primary:#333;--text-secondary:#555;--accent-color:#4CAF50;--neon-glow:none}.theme-blue-white{--primary-bg:#f7f9fd;--secondary-bg:#e3f2fd;--card-bg:#fff;--text-primary:#333;--text-secondary:#555;--accent-color:#2196F3;--neon-glow:none}*{margin:0;padding:0;box-sizing:border-box}html,body{height:100%;overflow:hidden}body{font-family:var(--font-family);background-color:var(--primary-bg);color:var(--text-primary);transition:background-color .3s,color .3s}@keyframes fadeIn{from{opacity:0;transform:scale(.95)}to{opacity:1;transform:scale(1)}}@keyframes beat{0%,100%{transform:scale(1)}50%{transform:scale(1.1)}}@keyframes slideInUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
    @keyframes bubble-fall {0% { transform: translateY(-10vh) translateX(0) scale(1); opacity: 1; } 50% { transform: translateY(50vh) translateX(var(--drift)) scale(0.8); } 100% { transform: translateY(110vh) translateX(0) scale(0.5); opacity: 0; }}
    .screen{display:none;flex-direction:column;align-items:center;justify-content:center;position:fixed;top:0;left:0;width:100%;height:100%;padding:0;background-color:var(--primary-bg);z-index:100;opacity:0;transform:scale(.98);transition:opacity .3s ease-out,transform .3s ease-out}.screen.active{display:flex;z-index:200;opacity:1;transform:scale(1)}#main-app-screen.active{z-index:150}#loading-screen.active{z-index:9999}.onboarding-screen{padding:20px}h1,h2,h3,.logo-text{color:var(--accent-color);text-align:center;margin-bottom:10px;text-shadow:var(--neon-glow)}h4{color:var(--accent-color);margin-top:20px;margin-bottom:10px;font-size:1.1rem}p{color:var(--text-secondary);text-align:center;max-width:400px;line-height:1.6}.button{background-color:var(--accent-color);color:#fff;padding:15px 30px;border:none;border-radius:50px;font-size:16px;font-weight:700;cursor:pointer;text-transform:uppercase;letter-spacing:1px;margin-top:20px;transition:background-color .3s,transform .2s,box-shadow .3s;box-shadow:0 4px 15px rgba(0,0,0,.2)}.button-secondary{background-color:transparent;border:2px solid var(--accent-color);color:var(--accent-color)}.button:disabled{background-color:#555;cursor:not-allowed; opacity: 0.7;}.button:hover:not(:disabled){background-color:var(--accent-dark);transform:translateY(-3px);box-shadow:0 6px 20px rgba(0,0,0,.3)}.form-container{background-color:var(--secondary-bg);padding:25px;border-radius:15px;width:100%;max-width:500px;display:flex;flex-direction:column;gap:20px;overflow-y:auto;max-height:90vh;animation:slideInUp .5s ease-out}.form-group{display:flex;flex-direction:column}.form-group label{margin-bottom:8px;color:var(--text-secondary);font-weight:700}.form-group input,.form-group select,.form-group textarea{width:100%;padding:12px;background-color:var(--primary-bg);border:1px solid #444;border-radius:8px;color:var(--text-primary);font-size:16px;transition:border-color .3s}.form-group input:focus,.form-group select:focus,.form-group textarea:focus{border-color:var(--accent-color);outline:0;box-shadow:0 0 8px var(--accent-color)}.form-group input.error,.form-group textarea.error{border-color:var(--error-color)}textarea{resize:vertical;min-height:100px}.hobby-grid,.avatar-grid,.zodiac-grid{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}.hobby-tag,.avatar-item,.zodiac-item{background-color:var(--primary-bg);padding:8px 15px;border-radius:20px;cursor:pointer;border:1px solid #555;transition:all .2s ease}.hobby-tag.selected,.avatar-item.selected,.zodiac-item.selected{background-color:var(--accent-color);color:#fff;border-color:var(--accent-color);transform:scale(1.05)}.zodiac-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(100px,1fr));gap:10px}.zodiac-item{text-align:center;font-size:14px;padding:15px 5px}
    @keyframes neon-pulse { 0%, 100% { transform: scale(1); opacity: 0.8; } 50% { transform: scale(1.1); opacity: 1; } }
    #loading-screen { background: linear-gradient(135deg, #000000 0%, #0d0a1f 50%, #1f103b 100%); }
    .loading-content { display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; }
    .loading-heart { font-size: 120px; color: #ff79c6; animation: neon-pulse 2s infinite ease-in-out; text-shadow: 0 0 10px #fff, 0 0 20px #ff00ff, 0 0 30px #ff00ff, 0 0 40px #ff00ff; }
    #loading-screen h1 { font-family: 'Poppins', sans-serif; font-size: 2.5rem; font-weight: 700; letter-spacing: 2px; color: #fff; text-shadow: 0 0 5px #fff, 0 0 10px #a259ff, 0 0 20px #a259ff; margin-top: 20px; }
    .loading-bar-container { position: absolute; bottom: -40px; width: 150px; height: 4px; background-color: rgba(255, 255, 255, 0.2); border-radius: 2px; overflow: hidden; }
    .loading-bar-fill { width: 100%; height: 100%; background: linear-gradient(90deg, #ff79c6, #a259ff, #6272a4); animation: loading-bar-anim 2s infinite linear; }
    @keyframes loading-bar-anim { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }
    #welcome-screen { background: linear-gradient(135deg, #000000 0%, #0d0a1f 50%, #1f103b 100%); }
    .welcome-content { display: flex; flex-direction: column; align-items: center; justify-content: center; }
    #welcome-screen .welcome-heart { font-size: 100px; color: #ff79c6; text-shadow: 0 0 10px #fff, 0 0 20px #ff00ff; animation: neon-pulse 2.5s infinite ease-in-out; margin-bottom: 20px; }
    #welcome-screen h1 { color: #fff; text-shadow: 0 0 5px #fff, 0 0 10px #a259ff; font-size: 3rem; margin-bottom: 10px; }
    #welcome-screen p { color: rgba(255, 255, 255, 0.8); margin-bottom: 30px; }
    #welcome-screen .button { background: transparent; border: 2px solid #ff79c6; color: #ff79c6; box-shadow: 0 0 15px rgba(255, 121, 198, 0.5); transition: all 0.3s ease; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; }
    #welcome-screen .button:hover { background: #ff79c6; color: #fff; box-shadow: 0 0 25px rgba(255, 121, 198, 0.8); }
    #welcome-screen .login-prompt { margin-top: 20px; font-size: 14px; }
    #welcome-screen .login-prompt a { color: #ff79c6; text-decoration: none; font-weight: bold; }
    #welcome-screen::before { content: none; }
    #questionnaire-progress, #compatibility-quiz-progress { width:80%; max-width:400px; height:8px; background-color:#444; border-radius:4px; margin-bottom:30px; overflow:hidden }
    #progress-bar, #compatibility-progress-bar { width:0%; height:100%; background-color:var(--accent-color); transition:width .3s ease }
    .question-option { background-color:var(--secondary-bg); width:100%; max-width:400px; padding:15px; margin:8px 0; border-radius:10px; cursor:pointer; text-align:center; border:1px solid #444; transition:all .2s }
    .question-option:hover { background-color:var(--card-bg); border-color:var(--accent-color); transform:translateY(-2px) }
    #main-app-screen{justify-content:flex-start; position: relative; overflow: hidden;}.main-app-layout{display:flex;flex-direction:column;width:100%;height:100%;}.top-bar{display:flex;justify-content:space-between;align-items:center;padding:15px;background-color:var(--secondary-bg);width:100%;flex-shrink:0;border-bottom:1px solid #333}.logo-container{display:flex;align-items:center;gap:15px}
    .logo-text{font-family:'Dancing Script',cursive;font-size:24px;color:var(--accent-color)}.menu-icon,.dots-icon{font-size:24px;cursor:pointer;color:var(--text-primary);padding:5px;border-radius:50%;transition:background-color .2s}.menu-icon:hover,.dots-icon:hover{background-color:var(--card-bg)}#user-pic-header{width:40px;height:40px;background-color:var(--accent-color);border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;color:#fff;object-fit:cover;overflow:hidden;border:2px solid var(--accent-color)}#user-pic-header img{width:100%;height:100%;object-fit:cover}.main-content{flex-grow:1;overflow-y:auto;position:relative}.view{display:none;padding:20px;height:100%;animation:fadeIn .4s ease; overflow-y: auto;}.view.active{display:block}#home-view.active{display:flex;flex-direction:column;align-items:center;justify-content:space-between;padding:0 20px 20px 20px;}
    .swipe-card-container{flex-grow:1;display:flex;align-items:center;justify-content:center;width:100%; position: relative; min-height: 450px; margin-top: 10px;}
    .swipe-card{width:90vw;max-width:400px;height:70vh;max-height:550px;background-color:var(--card-bg);border-radius:20px;position:absolute;overflow:hidden;box-shadow:0 10px 30px rgba(0,0,0,.3);display:flex;align-items:center;justify-content:center;text-align:center;color:var(--text-secondary);transition:transform .5s ease, opacity .5s ease; user-select: none; cursor: grab;}
    .swipe-card.dragging { transition: none; }
    .swipe-card:nth-child(1) { z-index: 3; }
    .swipe-card:nth-child(2) { z-index: 2; transform: translateY(-10px) scale(0.95); }
    .swipe-card:nth-child(3) { z-index: 1; transform: translateY(-20px) scale(0.9); }
    .swipe-card:nth-child(n+4) { display: none; }
    #no-more-profiles-card { flex-direction: column; text-align: center; padding: 20px; }
    #quote-text { font-style: italic; margin-bottom: 5px; }
    #quote-author { font-weight: bold; color: var(--accent-color); }
    .swipe-card img{width:100%;height:100%;object-fit:cover; pointer-events: none;}.card-info{position:absolute;bottom:0;left:0;width:100%;padding:20px;background:linear-gradient(to top,rgba(0,0,0,.9),transparent);color:#fff}.card-info h3,.card-info p{text-align:left}.card-info .compatibility-insight { font-size: 13px; text-align: left; margin-top: 5px; font-style: italic; color: #f0f0f0; opacity: 0.9; } .swipe-card .card-nav-arrow{position:absolute;top:50%;transform:translateY(-50%);background-color:rgba(0,0,0,.3);color:#fff;border-radius:50%;width:30px;height:30px;display:flex;align-items:center;justify-content:center;font-size:20px;cursor:pointer;z-index:5;user-select:none}.swipe-card .left{left:10px}.swipe-card .right{right:10px}.swipe-card .image-counter{position:absolute;top:15px;left:50%;transform:translateX(-50%);background-color:rgba(0,0,0,.5);color:#fff;padding:3px 10px;border-radius:15px;font-size:12px;font-weight:700;z-index:5}.swipe-actions{display:flex;justify-content:space-evenly;align-items:center;width:100%;max-width:400px;padding:20px 0;flex-shrink:0}.action-btn{width:60px;height:60px;border-radius:50%;border:2px solid #555;background-color:var(--secondary-bg);color:#fff;font-size:24px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s ease}.action-btn:hover{transform:scale(1.1)}.action-btn.like{border-color:var(--success-color);color:var(--success-color)}.action-btn.dislike{border-color:var(--error-color);color:var(--error-color);}.action-btn-details { background-color: var(--secondary-bg); border: 2px solid var(--accent-color); color: var(--accent-color); padding: 10px 20px; border-radius: 50px; font-weight: 700; cursor: pointer; transition: all 0.2s ease; font-size: 14px; }
    .action-btn-details:hover { background-color: var(--accent-color); color: #fff;}
    .chat-list, .likes-list {list-style-type:none; padding: 0;}.chat-item, .like-item {display:flex;align-items:center;padding:15px 5px;border-bottom:1px solid #444;animation:slideInUp .3s ease-out; transition: opacity 0.3s ease;}.like-item { justify-content: space-between; }.chat-item-left{display:flex;align-items:center;cursor:pointer;flex-grow:1; min-width: 0;}
    .chat-item-delete-btn { font-size: 20px; color: var(--text-secondary); padding: 10px; cursor: pointer; border-radius: 50%; }
    .chat-item-delete-btn:hover { background-color: var(--card-bg); color: var(--error-color); }
    .chat-avatar{width:50px;height:50px;border-radius:50%;background-color:var(--accent-color);margin-right:15px;display:flex;align-items:center;justify-content:center;font-weight:700;position:relative;color:#fff;overflow:hidden;flex-shrink:0}.chat-avatar img{width:100%;height:100%;object-fit:cover}.active-dot{width:12px;height:12px;background-color:var(--success-color);border-radius:50%;border:2px solid var(--primary-bg);position:absolute;bottom:0;right:0; display: none;}.active-dot.is-active{display: block;}.chat-details {flex-grow: 1; min-width: 0;}.chat-details h4{margin:0;font-size:16px;color:var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;}.chat-details p{margin:0;font-size:14px;text-align:left;color:var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: flex; align-items: center;}.read-receipt {font-size: 16px; margin-right: 5px; color: var(--text-secondary);}.read-receipt.seen {color: var(--accent-color);}#profile-view-content{word-wrap:break-word}
    .vibe-badge { background-color: var(--accent-color); color: white; padding: 5px 12px; border-radius: 20px; font-size: 14px; font-weight: 600; display: inline-block; margin-top: 15px; }
    #profile-detail-content.vibe-artistic { background: linear-gradient(45deg, #6a11cb 0%, #2575fc 100%); color: white; border-radius: 15px; padding: 25px; }
    #profile-detail-content.vibe-artistic h4 { color: #fff; border-bottom: 1px solid rgba(255,255,255,0.5); }
    #profile-detail-content.vibe-artistic p, #profile-detail-content.vibe-artistic li { color: #f0f0f0; }
    #profile-detail-content.vibe-minimalist { background-color: #f5f5f5; color: #333; border: 1px solid #ddd; border-radius: 15px; padding: 25px; }
    #profile-detail-content.vibe-minimalist h4 { color: #000; font-family: 'Helvetica Neue', sans-serif; }
    #profile-detail-content.vibe-minimalist p, #profile-detail-content.vibe-minimalist li { color: #555; }
    #profile-detail-content.vibe-retro { background-color: #fdf5e6; color: #5d4037; font-family: 'Courier New', monospace; border-radius: 15px; padding: 25px; border: 2px dashed #d7ccc8; }
    #profile-detail-content.vibe-retro h4 { color: #d35400; text-transform: uppercase; letter-spacing: 1px; }
    .profile-codes-container{display: flex; flex-direction: column; gap: 15px; margin-top: 20px;} #profile-id-container, #my-referral-code-container {background-color:var(--secondary-bg);padding:15px;border-radius:10px;display:flex;justify-content:space-between;align-items:center}#profile-id, #my-referral-code{font-family:monospace;font-size:16px}#copy-id-btn, #copy-referral-btn {background:var(--accent-color);color:#fff;border:none;padding:8px 12px;border-radius:5px;cursor:pointer}.bottom-nav{display:flex;justify-content:space-around;background-color:var(--secondary-bg);padding:10px 0;width:100%;border-top:1px solid #444;flex-shrink:0;box-shadow:0 -5px 15px rgba(0,0,0,.2)}.nav-item{position: relative; display:flex;flex-direction:column;align-items:center;color:var(--text-secondary);cursor:pointer;padding:5px 10px;font-size:12px;border-top:3px solid transparent;transition:all .2s; width: 20%;}.nav-item svg{width:24px;height:24px;margin-bottom:4px}.nav-item.active{color:var(--accent-color);border-top-color:var(--accent-color)}.nav-item.active svg{filter:drop-shadow(var(--neon-glow))}#side-menu,#theme-modal{position:fixed;top:0;background-color:var(--secondary-bg);height:100%;z-index:1000;box-shadow:5px 0 15px rgba(0,0,0,.3);transition:transform .3s ease-in-out;padding:20px;overflow-y:auto}#side-menu{width:80%;max-width:300px;left:0;transform:translateX(-100%)}#side-menu.open{transform:translateX(0)}#theme-modal{width:80%;max-width:300px;right:0;transform:translateX(100%)}#theme-modal.open{transform:translateX(0)}.menu-item{display:block;text-decoration:none;padding:12px 15px;margin-bottom:8px;border-radius:10px;background-color:var(--card-bg);color:var(--text-primary);cursor:pointer;transition:background-color .2s,transform .2s}.menu-item:hover{background-color:var(--accent-color);transform:scale(1.03)}#chat-side-menu{position:fixed;top:0;right:0;width:80%;max-width:300px;height:100%;background-color:var(--secondary-bg);z-index:1200;transform:translateX(100%);transition:transform .3s ease-in-out;box-shadow:-5px 0 15px rgba(0,0,0,.3);padding-top:50px}#chat-side-menu.open{transform:translateX(0)}#chat-menu-overlay{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,.5);z-index:1199}#chat-menu-overlay.active{display:block}.chat-menu-item{padding:15px 20px;border-bottom:1px solid #444;cursor:pointer;transition:background-color .2s;display:flex;align-items:center;gap:15px}.chat-menu-item:hover{background-color:var(--card-bg)}.chat-menu-item:last-child{border-bottom:none}.fab{position:fixed;bottom:80px;right:20px;width:55px;height:55px;background-color:var(--accent-color);border-radius:50%;display:none;align-items:center;justify-content:center;font-size:24px;cursor:pointer;box-shadow:0 4px 10px rgba(0,0,0,.3);z-index:999;color:#fff;transition:all .3s}.fab:hover{transform:scale(1.1) rotate(15deg)}.chat-layout,.policy-layout{display:flex;flex-direction:column;width:100%;height:100%;position:relative;overflow:hidden;}.chat-header,.policy-header{display:flex;align-items:center;justify-content:space-between;padding:10px 15px;background-color:var(--secondary-bg);flex-shrink:0; z-index: 5;}.chat-header-left{display:flex;align-items:center;gap:10px;flex-grow:1;min-width:0}.back-btn{background:0 0;border:none;color:var(--text-primary);font-size:24px;margin-right:5px;cursor:pointer}.chat-header-info{display:flex;flex-direction:column;align-items:flex-start;flex-grow:1;min-width:0;}.chat-header-info-main {display:flex; align-items:center; gap:10px;}#chat-with-name{margin:0;text-align:left;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;color:#fff;font-weight:700}#chat-user-status {font-size: 12px; color: var(--text-secondary); margin: 0; min-height: 14px;}#chat-avatar-header{width:40px;height:40px}.chat-header-menu-icon{font-size:28px;font-weight:700;cursor:pointer;padding:5px 10px;border-radius:50%;line-height:1;transition:background-color .2s;flex-shrink:0}.chat-header-menu-icon:hover{background-color:var(--card-bg)}#message-area{flex-grow:1;overflow-y:auto;padding:15px;display:flex;flex-direction:column;gap:10px;position:relative}#icebreaker-suggestion{background-color:var(--card-bg);padding:12px;border-radius:10px;text-align:center;cursor:pointer;margin-bottom:10px;font-style:italic;color:var(--text-secondary); display: none;}.icebreaker-suggestion:hover{background-color:var(--accent-dark);color:#fff}.message-wrapper{display:flex;flex-direction:column;max-width:80%; margin-bottom: 2px; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none;}.message-wrapper.outgoing{align-self:flex-end; align-items:flex-end;}.message-wrapper.incoming{align-self:flex-start; align-items:flex-start;}.message{max-width:100%;padding:10px 15px;border-radius:18px;line-height:1.4;user-select:text;transition:background-color .3s;z-index:2;word-wrap:break-word}.message.incoming{background-color:var(--card-bg);border-bottom-left-radius:4px}.message.outgoing{background-color:var(--accent-color);color:#fff;border-bottom-right-radius:4px}.message-status{font-size:11px; color:var(--text-secondary); margin: 4px 8px 0 0;}.message-status.seen{color:var(--accent-color);}
    #bubble-background{position:absolute;top:0;left:0;width:100%;height:100%;overflow:hidden;z-index:1;pointer-events:none}
    .bubble{ position:absolute; border-radius:50%; animation-name: bubble-fall; animation-timing-function: linear; animation-iteration-count: infinite; --glow-color: var(--accent-color); box-shadow: 0 0 8px rgba(255, 255, 255, 0.4), 0 0 15px var(--glow-color), 0 0 25px var(--glow-color); }
    .deleted-message { background:transparent !important; color: var(--text-secondary); font-style: italic; padding: 5px 15px !important; cursor: pointer; }
    .sticker-message { font-size: 3.5rem; background: transparent; padding: 0; line-height: 1; }
    .chat-footer{display:flex;align-items:center;padding:10px;background-color:var(--secondary-bg);flex-shrink:0;z-index:5; flex-wrap: wrap;}
    .chat-input-area { display: flex; align-items: center; width: 100%; }
    #message-input{flex-grow:1;padding:12px;border-radius:20px;background-color:var(--card-bg);color:var(--text-primary);font-size:16px;margin:0 5px;border:1px solid #444;transition:all .3s}
    #message-input:focus{border-color:var(--accent-color);box-shadow:0 0 8px var(--accent-color)}
    .chat-footer-btn { background-color:var(--accent-color); border:none; color:#fff; width:40px; height:40px; border-radius:50%; font-size:18px; cursor:pointer; flex-shrink:0; transition:transform .2s, background-color .2s; display: flex; align-items: center; justify-content: center; }
    .send-btn { width: 45px; height: 45px; font-size: 20px;}
    .hide-keyboard-btn { background-color: var(--secondary-bg); color: var(--text-secondary); font-size: 24px; margin-left: 5px; width: 45px; height: 45px; }
    .send-btn:disabled { background-color:#555; cursor:not-allowed; transform:scale(1) }
    .send-btn:hover:not(:disabled), .sticker-btn:hover, .hide-keyboard-btn:hover { transform:scale(1.1) }
    .modal-overlay{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,.75);z-index:3000;justify-content:center;align-items:center;padding:20px}.modal-overlay.active{display:flex;animation:fadeIn .3s}.modal-content{position:relative;background-color:var(--secondary-bg);padding:30px;border-radius:20px;text-align:center;max-width:320px;width:100%;animation:fadeIn .3s ease}.modal-heart{font-size:60px;color:var(--accent-color);margin-bottom:15px;animation:beat 1.5s infinite;text-shadow:var(--neon-glow)}#custom-alert-modal .modal-content{padding-bottom:20px;max-height:80vh;overflow-y:auto}#custom-alert-modal .modal-actions{display:flex;justify-content:center;gap:15px;margin-top:25px}.modal-close-btn{position:absolute;top:10px;right:10px;font-size:24px;color:var(--text-secondary);background:0 0;border:none;cursor:pointer;line-height:1;padding:5px}.modal-header{display:flex;align-items:center;justify-content:center;position:relative;margin-bottom:10px}.modal-back-btn{position:absolute;left:0;top:50%;transform:translateY(-50%);background:0 0;border:none;font-size:24px;color:var(--text-primary);cursor:pointer;padding:5px}.modal-header h2{flex-grow:1;text-align:center;margin:0}#chat-theme-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(100px,1fr));gap:15px;margin-top:20px}.chat-theme-item{width:100%;padding:15px;border-radius:10px;cursor:pointer;border:2px solid #555;transition:all .2s;text-align:center;font-weight:700}.chat-theme-item:hover{transform:scale(1.05);border-color:var(--accent-color)}.theme-swatch{width:30px;height:30px;border-radius:50%;margin:0 auto 10px;background-size:cover;background-position:center;border:1px solid rgba(255,255,255,.2)}.policy-layout{padding:0 15px}.policy-content{background-color:var(--card-bg);padding:25px;border-radius:15px;height:calc(100% - 80px);overflow-y:auto}.policy-content h4{font-size:1.2rem;margin-top:25px;margin-bottom:5px;color:var(--accent-color)}.policy-content p,.policy-content li{text-align:left;color:var(--text-secondary);max-width:none;line-height:1.7}.policy-content ul{padding-left:20px;margin-top:10px;list-style-type:disc}.policy-content hr{border:none;border-top:1px solid #444;margin:30px 0}#auto-hide-popup{visibility:hidden;opacity:0;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%) scale(.8);background-color:var(--card-bg);color:#fff;padding:20px 30px;border-radius:15px;z-index:5000;text-align:center;box-shadow:0 10px 30px rgba(0,0,0,.5);transition:opacity .3s ease,transform .3s ease,visibility .3s;display:flex;align-items:center;gap:15px}#auto-hide-popup.show{visibility:visible;opacity:1;transform:translate(-50%,-50%) scale(1)}#popup-icon{font-size:24px}#popup-text{font-size:16px;font-weight:700}.profile-completion{margin:20px 0}.progress-container{width:100%;background-color:#555;border-radius:10px;overflow:hidden}.progress-bar-fill{width:0%;height:20px;background-color:var(--success-color);text-align:center;line-height:20px;color:#fff;font-weight:700;transition:width .5s ease}
    #message-delete-modal .modal-actions { display: flex; flex-direction: column; gap: 15px; width: 100%;}
    #message-delete-modal .button-wrapper { background-color: var(--card-bg); border: 1px solid var(--text-secondary); border-radius: 12px; padding: 3px; }
    #message-delete-modal .button { width: 100%; margin: 0; padding: 12px; font-size: 14px; background-color: transparent; border: none; color: var(--text-primary); text-transform: none; font-weight: 500;}
    #message-delete-modal .button-wrapper:hover { border-color: var(--accent-color); }
    #message-delete-modal #delete-for-everyone-btn-wrapper { border-color: var(--error-color); }
    #message-delete-modal #delete-for-everyone-btn { color: var(--error-color); }
    #achievements-section { margin-top: 25px; }
    .achievements-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
    .how-to-btn { background-color: var(--card-bg); color: var(--text-secondary); border: 1px solid #555; padding: 6px 12px; border-radius: 20px; cursor: pointer; font-size: 12px; font-weight: 600; transition: all 0.2s ease; }
    .how-to-btn:hover { background-color: var(--accent-color); color: #fff; border-color: var(--accent-color); }
    .achievements-grid-wrapper { overflow-x: auto; padding-bottom: 15px; }
    .achievements-grid-wrapper::-webkit-scrollbar { display: none; }
    .achievements-grid-wrapper { -ms-overflow-style: none; scrollbar-width: none; }
    .achievements-grid { display: flex; flex-direction: row; gap: 15px; width: max-content; }
    .achievement-item { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 8px; background-color: var(--secondary-bg); padding: 15px; border-radius: 15px; width: 120px; height: 140px; text-align: center; border: 2px solid var(--secondary-bg); transition: all .3s ease; }
    .achievement-item.unlocked { border-color: var(--accent-color); box-shadow: 0 0 10px rgba(233, 30, 99, 0.5); }
    .achievement-item .badge-icon { font-size: 48px; filter: grayscale(1); opacity: 0.5; transition: all .3s ease-in-out; }
    .achievement-item.unlocked .badge-icon { filter: grayscale(0); opacity: 1; color: var(--accent-color); transform: scale(1.15); }
    .achievement-info-item{ display: flex; align-items: center; gap: 15px; text-align: left; padding: 12px 0; border-bottom: 1px solid #444; }
    .achievement-info-item:last-child{border-bottom:none}
    .achievement-info-item .badge-icon{font-size:32px; color: var(--accent-color);}
    #explore-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
    .explore-card { background-color: var(--card-bg); border-radius: 15px; overflow: hidden; cursor: pointer; position: relative; aspect-ratio: 1 / 1.2; transition: transform 0.2s ease-in-out; }
    .explore-card:hover { transform: scale(1.05); }
    .explore-card img { width: 100%; height: 100%; object-fit: cover; }
    .explore-card-info { position: absolute; bottom: 0; left: 0; right: 0; padding: 8px; background: linear-gradient(to top, rgba(0,0,0,0.8), transparent); color: #fff; font-size: 14px; font-weight: 600; }
    #sparks-view .content-wrapper { display: flex; flex-direction: column; gap: 30px; width: 100%; max-width: 500px; margin: 0 auto;}
    .spark-container { background-color: var(--card-bg); padding: 20px; border-radius: 15px; }
    .spark-container h3 { margin-top: 0; border-bottom: 1px solid var(--accent-color); padding-bottom: 10px; }
    .spark-option { background-color: var(--secondary-bg); padding: 12px; margin-top: 10px; border-radius: 8px; cursor: pointer; border: 1px solid #444; transition: all 0.2s; }
    .spark-option:hover { background-color: var(--accent-dark); color: #fff; }
    #spark-quiz-result { margin-top: 15px; font-style: italic; color: var(--text-secondary); }
    .like-item-info { display: flex; align-items: center; gap: 10px; flex-grow: 1; cursor: pointer;}
    .like-item-actions { display: flex; gap: 10px; }
    .like-item-actions button { border: none; width: 40px; height: 40px; border-radius: 50%; font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all .2s; }
    .like-item-actions .accept-like { background-color: var(--success-color); color: #fff; }
    .like-item-actions .decline-like { background-color: var(--error-color); color: #fff; }
    .nav-badge { position: absolute; top: 2px; right: 15px; background-color: var(--error-color); color: #fff; border-radius: 50%; width: 18px; height: 18px; font-size: 11px; font-weight: bold; display: none; justify-content: center; align-items: center; line-height: 1; }
    #match-modal-content { display: flex; flex-direction: column; align-items: center; }
    #match-avatars { display: flex; position: relative; justify-content: center; align-items: center; margin: 15px 0; }
    #match-avatars .avatar { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 3px solid #fff; box-shadow: 0 0 10px rgba(0,0,0,0.5); }
    #match-avatars .avatar1 { transform: translateX(20px) rotate(-10deg); }
    #match-avatars .avatar2 { transform: translateX(-20px) rotate(10deg); z-index: 1; }
    #match-modal .modal-heart { font-size: 40px; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 2; }
    #interactive-glow { display: none; }
    @keyframes fly-to-position { 0% { transform: translate(var(--start-x), var(--start-y)) scale(0.5); opacity: 0.8; } 100% { transform: translate(0, 0) scale(1); opacity: 1; } }
    .message-wrapper.fly-in { animation: fly-to-position 0.4s ease-out; }
    #blocked-user-banner { display: none; padding: 15px; background-color: var(--card-bg); text-align: center; margin: 10px; border-radius: 10px; }
     #blocked-user-banner button { background-color: var(--accent-color); color: #fff; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; margin-left: 10px; }
    .blocked-user-item { display: flex; align-items: center; justify-content: space-between; padding: 10px; background-color: var(--card-bg); border-radius: 8px; margin-bottom: 10px; }
    .blocked-user-info { display: flex; align-items: center; gap: 15px; }
    .chat-item.blocked { opacity: 0.6; }
    .chat-item .blocked-icon { color: var(--error-color); margin-left: auto; font-size: 20px; padding: 0 10px; }
    .game-message-container { background-color: var(--card-bg); border-radius: 15px; padding: 15px; margin: 5px 0; border: 1px solid var(--accent-color); }
    .game-message-container * { user-select: text; }
    .game-title { font-weight: bold; color: var(--accent-color); margin-bottom: 10px; text-align: center; }
    .game-instructions { font-size: 14px; color: var(--text-secondary); margin-bottom: 15px; font-style: italic; text-align: center; }
    .game-content { display: flex; flex-direction: column; gap: 10px; }
    .game-content .game-input { width: 100%; padding: 8px; background-color: var(--primary-bg); border: 1px solid #444; border-radius: 5px; color: var(--text-primary); }
    .game-content .button { margin-top: 10px; padding: 10px 20px; font-size: 14px; width: 100%; }
    .game-statement-option { background-color: var(--secondary-bg); padding: 10px; border-radius: 8px; margin-bottom: 8px; cursor: pointer; transition: background-color .2s; }
    .game-statement-option:hover { background-color: var(--accent-dark); }
    #sticker-panel { display: none; width: 100%; background-color: var(--primary-bg); border-top: 1px solid #444; padding: 10px; max-height: 250px; overflow-y: auto; }
    .sticker-tabs { display: flex; overflow-x: auto; border-bottom: 1px solid #444; margin-bottom: 10px; padding-bottom: 5px; }
    .sticker-tabs::-webkit-scrollbar { display: none; }
    .sticker-tab { padding: 8px 15px; cursor: pointer; color: var(--text-secondary); white-space: nowrap; border-bottom: 2px solid transparent; }
    .sticker-tab.active { color: var(--accent-color); border-bottom-color: var(--accent-color); }
    .sticker-content { display: none; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 15px; }
    .sticker-content.active { display: grid; }
    .sticker-item { display: flex; flex-direction: column; align-items: center; cursor: pointer; }
    .sticker-item:hover { transform: scale(1.1); }
    .sticker-item span { font-size: 48px; }
    #tutorial-modal .modal-content { max-width: 90vw; max-height: 85vh; padding: 15px; }
    #tutorial-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
    #tutorial-language-selector { background-color: var(--primary-bg); color: var(--text-primary); border: 1px solid #555; border-radius: 5px; padding: 5px;}
    #tutorial-page-content { text-align: left; }
    #tutorial-page-content img { max-width: 100%; border-radius: 10px; margin: 15px 0; }
    #tutorial-page-content h3 { color: var(--accent-color); text-align: left; }
    #tutorial-page-content p { color: var(--text-secondary); text-align: left; max-width: 100%;}
    #tutorial-nav { display: flex; justify-content: space-between; align-items: center; margin-top: 20px; }
</style>

</head>
<body class="theme-dark">

<div id="interactive-glow"></div>

<div id="loading-screen" class="screen active">
    <div class="loading-content">
        <div class="loading-heart">♡</div>
        <h1>Soul Spark</h1>
        <div class="loading-bar-container">
            <div class="loading-bar-fill"></div>
        </div>
    </div>
</div>

<div id="auto-hide-popup"><span id="popup-icon">❤️</span><span id="popup-text"></span></div>
<div id="match-modal" class="modal-overlay"><div class="modal-content" id="match-modal-content"><h2 class="modal-title">It's a Match!</h2><p id="match-modal-text"></p><div id="match-avatars"></div><button class="button" id="match-modal-chat-btn">Say Hello</button><button class="button button-secondary" onclick="document.getElementById('match-modal').classList.remove('active')">Keep Swiping</button></div></div>
<div id="flirt-modal" class="modal-overlay"><div class="modal-content"><div class="modal-heart">💌</div><h2 class="modal-title">Ek meethi si yaad dila doon?</h2><p>Is pyaari si line ko apna lo…aur yeh apne massage me dal ke dekho</p><div id="flirt-line-container"><div id="flirt-line-display"></div><button id="change-flirt-line-btn" onclick="changeFlirtLine()">🔄</button></div><div class="modal-actions"><button class="button" id="copy-flirt-btn">✓ Jaisa tum chaho...</button><button class="button button-secondary" id="cancel-flirt-btn">✕ Dil ne mana kar diya...</button></div></div></div>
<div id="filter-modal" class="modal-overlay"><div class="modal-content"><div class="modal-heart">❤️</div><h2 class="modal-title">Zaroori si baat hai tumse</h2><p class="modal-text">Filters Applied!</p><button class="button" onclick="hideFilterAppliedModal()">Tumhare liye toh hamesha haan...</button></div></div>
<div id="custom-alert-modal" class="modal-overlay">
    <div class="modal-content">
        <button class="modal-close-btn" id="custom-alert-close-btn" onclick="this.parentElement.parentElement.classList.remove('active')">✕</button>
        <div class="modal-heart" id="custom-alert-icon">⭐</div>
        <h2 class="modal-title" id="custom-alert-title"></h2>
        <div id="custom-alert-text"></div>
        <div class="modal-actions" id="custom-alert-actions"></div>
    </div>
</div>
<div id="message-delete-modal" class="modal-overlay">
    <div class="modal-content">
        <button class="modal-close-btn" onclick="this.parentElement.parentElement.classList.remove('active')">✕</button>
        <div class="modal-heart">💔</div>
        <h2 class="modal-title">Delete Message</h2>
        <div class="modal-actions">
            <div class="button-wrapper"><button class="button" id="delete-for-me-btn">Delete for Me</button></div>
            <div class="button-wrapper" id="delete-for-everyone-btn-wrapper"><button class="button" id="delete-for-everyone-btn">Delete for Everyone</button></div>
        </div>
    </div>
</div>
<div id="game-selection-modal" class="modal-overlay">
    <div class="modal-content">
        <button class="modal-close-btn" onclick="this.parentElement.parentElement.classList.remove('active')">✕</button>
        <div class="modal-heart">🎮</div>
        <h2 class="modal-title">Play a Game!</h2>
        <p>Break the ice with a fun game.</p>
        <div class="modal-actions" style="flex-direction: column;">
            <button class="button" id="game-two-truths-btn">Two Truths, One Lie</button>
            <button class="button button-secondary" disabled>Would You Rather? (soon)</button>
        </div>
    </div>
</div>
<div id="blocked-users-modal" class="modal-overlay">
    <div class="modal-content" style="max-height: 80vh; overflow-y: auto;">
        <button class="modal-close-btn" onclick="this.parentElement.parentElement.classList.remove('active')">✕</button>
        <h2 class="modal-title">Blocked Users</h2>
        <div id="blocked-users-list" style="margin-top: 20px;"></div>
    </div>
</div>
<div id="chat-menu-overlay" onclick="toggleChatMenu(false)"></div>
<div id="chat-side-menu">
    <div class="chat-menu-item" onclick="openChatThemeSelector()"><span>🎨</span> Change Chat Theme</div>
    <div class="chat-menu-item" id="chat-mismatch-btn"><span>💔</span> Mismatch</div>
    <div class="chat-menu-item" id="report-user-btn"><span>⚠️</span> Report User</div>
    <div class="chat-menu-item" id="chat-block-option"><span>🚫</span> Block User</div>
    <div class="chat-menu-item" onclick="toggleChatMenu(false)"><span>⬅️</span> Back</div>
</div>
<div id="chat-theme-selector-modal" class="modal-overlay">
    <div class="modal-content" style="max-height: 80vh; overflow-y: auto;">
        <div class="modal-header">
            <button class="modal-back-btn" onclick="closeChatThemeSelector()">←</button>
            <h2 class="modal-title">Select a Chat Background</h2>
        </div>
        <div id="chat-theme-grid"></div>
    </div>
</div>

<!-- Tutorial Modal -->
<div id="tutorial-modal" class="modal-overlay">
    <div class="modal-content">
        <div id="tutorial-header">
            <h2 class="modal-title" style="margin: 0;">How to Use Soul Spark</h2>
            <select id="tutorial-language-selector">
                <option value="en">English</option>
                <option value="hi">हिन्दी</option>
                <option value="mr">मराठी</option>
            </select>
            <button class="modal-close-btn" onclick="document.getElementById('tutorial-modal').classList.remove('active')">✕</button>
        </div>
        <div id="tutorial-page-content"></div>
        <div id="tutorial-nav">
            <button class="button button-secondary" id="tutorial-back-btn">Back</button>
            <span id="tutorial-page-counter"></span>
            <button class="button" id="tutorial-next-btn">Next</button>
        </div>
    </div>
</div>


<!-- ONBOARDING SCREENS -->
<!-- ▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼ -->
<!-- ===== यहाँ मैंने आपकी रिक्वेस्ट के अनुसार, वेलकम स्क्रीन को अपडेट किया है ===== -->
<!-- ▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼ -->
<div id="welcome-screen" class="screen onboarding-screen" style="background-image: url('https://i.ibb.co/1t1wMQfY/Pa-Ki-Fh-6-Sgi-Y-7i-Ct7-Ot-AA.webp'); background-size: cover; background-position: center; position: relative;">
    <!-- Text को पढ़ने लायक बनाने के लिए ओवरले -->
    <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0,0,0,0.5); z-index: 1;"></div>
    
    <!-- ओवरले के ऊपर कंटेंट -->
    <div class="welcome-content" style="position: relative; z-index: 2;">
        <div class="welcome-heart">♡</div>
        <h1 style="color: #ffffff; text-shadow: 0 0 8px rgba(0,0,0,0.7);">Soul Spark</h1>
        <p style="color: #f0f0f0; text-shadow: 0 0 5px rgba(0,0,0,0.7);">Find your spark, one swipe at a time.</p>
        <button class="button" id="get-started-btn">Get Started</button>
        <p class="login-prompt">Already have an account? <a id="welcome-login-link">Log in</a></p>
    </div>
</div>
<!-- ▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲ -->
<!-- ===== अपडेट का अंत ===== -->
<!-- ▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲ -->


<div id="login-screen" class="screen onboarding-screen"><div class="form-container" style="max-width: 400px;"><h2>Login to Your Account</h2><div class="form-group"><label for="login-email">Email ID</label><input type="email" id="login-email" placeholder="you@example.com"></div><div class="form-group"><label for="login-password">Password</label><input type="password" id="login-password" placeholder="••••••••"></div><button class="button" id="login-btn">Login</button><button class="button button-secondary" id="login-back-btn">Back</button></div></div>
<div id="questionnaire-screen" class="screen onboarding-screen"><div class="form-container"><div id="questionnaire-progress"><div id="progress-bar"></div></div><h2 id="question-text">Question goes here...</h2><div id="question-options"></div><button class="button button-secondary" id="skip-questions-btn">Skip Questions</button></div></div>
<div id="zodiac-screen" class="screen onboarding-screen"><div class="form-container"><h2>What's Your Zodiac Sign?</h2><div class="zodiac-grid" id="zodiac-grid"></div><button class="button" id="zodiac-continue-btn">Continue</button><button class="button button-secondary" id="zodiac-skip-btn">Skip</button></div></div>
<div id="referral-screen" class="screen onboarding-screen"><div class="form-container"><h2>Have a Referral Code?</h2><p>If a friend invited you, enter their code here to give them credit!</p><div class="form-group"><label for="referral-code">Referral Code</label><input type="text" id="referral-code" placeholder="e.g. SPARK-ABC123"></div><button class="button" id="referral-submit-btn">Submit & Continue</button><button class="button button-secondary" id="referral-skip-btn">Skip</button></div></div>
<div id="compatibility-quiz-screen" class="screen onboarding-screen">
    <div class="form-container">
        <div id="compatibility-quiz-progress"><div id="compatibility-progress-bar"></div></div>
        <h2>A Quick Vibe Check!</h2>
        <p>Answer a few questions to find your personality vibe.</p>
        <h3 id="compatibility-question-text" style="margin-top:20px;">Question...</h3>
        <div id="compatibility-question-options"></div>
    </div>
</div>
<div id="profile-creation-screen" class="screen onboarding-screen"><div class="form-container">
    <h2>Create Your Profile</h2>
    <div class="form-group"><label for="name">Full Name</label><input type="text" id="name" placeholder="e.g. Aanya Sharma"></div>
    <div class="form-group"><label for="email">Email ID</label><input type="email" id="email" placeholder="you@example.com"></div>
    <div class="form-group"><label for="password">Create Password</label><input type="password" id="password" placeholder="Minimum 6 characters"></div>
    <div class="form-group"><label for="mobile">Mobile Number</label><input type="tel" id="mobile" placeholder="+91 98765 43210"></div>
    <div class="form-group"><label>Profile Pictures (up to 4)</label><div id="profile-pics-preview" class="avatar-grid" style="min-height: 50px; border: 1px dashed #555; padding: 10px; align-items: center; justify-content: center;"><p style="color: var(--text-secondary); font-size: 14px; text-align: center; width: 100%;">Upload your photos here</p></div><button id="upload_widget_profile" class="button button-secondary" style="margin-top:10px; width:100%;">Upload Pictures</button></div>
    <div class="form-group"><label for="dob">Date of Birth</label><input type="date" id="dob"></div>
    <div class="form-group"><label for="gender">Gender</label><select id="gender"><option value="Woman">Woman</option><option value="Man">Man</option><option value="Non-binary">Non-binary</option></select></div>
    <div class="form-group"><label for="city">Current City</label><input type="text" id="city" placeholder="e.g. Mumbai"></div>
    <div class="form-group"><label for="state">State</label><input type="text" id="state" placeholder="e.g. Maharashtra"></div>
    <div class="form-group"><label for="bio">Your Bio (Max 2000 words)</label><textarea id="bio" placeholder="Tell everyone about yourself..."></textarea></div>
    <h4>Answer a few prompts...</h4>
    <div class="form-group"><label for="prompt1">My simple pleasures are...</label><input type="text" id="prompt1" placeholder="e.g., A cup of chai in the rain"></div>
    <div class="form-group"><label for="prompt2">I'm looking for someone who...</label><input type="text" id="prompt2" placeholder="e.g., Is kind and loves to travel"></div>
    <div class="form-group"><label for="prompt3">A perfect Sunday for me is...</label><input type="text" id="prompt3" placeholder="e.g., Reading a book and relaxing"></div>
    <div style="display: flex; gap: 10px; margin-top: 10px;">
        <button type="button" class="button button-secondary" style="width: 50%;" onclick="showScreen('referral-screen')">Back</button>
        <button class="button" id="profile-next-btn" style="width: 50%;">Next</button>
    </div>
</div></div>
<div id="details-screen" class="screen onboarding-screen"><div class="form-container">
    <h2>Tell Us More About You</h2>
    <div class="form-group"><label for="height">Height (e.g., 5' 10") (Optional)</label><input type="text" id="height" placeholder="e.g., 5' 10""></div>
    <div class="form-group"><label for="religion">Religion (Optional)</label><input type="text" id="religion" placeholder="e.g., Spiritual"></div>
    <div class="form-group"><label for="homeTown">Home Town (Optional)</label><input type="text" id="homeTown" placeholder="e.g., Lucknow"></div>
    <div class="form-group"><label for="workplaceCity">Workplace City (Optional)</label><input type="text" id="workplaceCity" placeholder="e.g., Bengaluru"></div>
    <div class="form-group"><label>Languages You Speak (Optional)</label><div class="hobby-grid" id="language-tags"></div></div>
    <div class="form-group"><label>Education</label><select id="education"><option>High School</option><option>Bachelor's Degree</option><option>Master's Degree</option><option>PhD</option><option>Other</option></select></div>
    <div class="form-group"><label>Profession</label><input type="text" id="profession" placeholder="e.g., Software Engineer"></div>
    <div class="form-group"><label>Drinking</label><select id="drinking"><option>Yes</option><option>Socially</option><option>No</option></select></div>
    <div class="form-group"><label>Smoking</label><select id="smoking"><option>Yes</option><option>Occasionally</option><option>No</option></select></div>
    <div class="form-group"><label>Dietary Preference</label><select id="diet"><option>Vegetarian</option><option>Non-Vegetarian</option><option>Vegan</option><option>Eggetarian</option></select></div>
    <div class="form-group"><label>Hobbies</label><div class="hobby-grid" id="hobbies-profile"></div></div>
    <div class="form-group"><label>Interests</label><div class="hobby-grid" id="interests-details"></div></div>
    <div class="form-group">
        <label>Set Your Profile Vibe</label>
        <select id="profile-vibe">
            <option value="default">Default</option>
            <option value="artistic">Artistic</option>
            <option value="minimalist">Minimalist</option>
            <option value="retro">Retro</option>
        </select>
    </div>
    <!-- ▼▼▼▼▼▼ आपकी रिक्वेस्ट के अनुसार, मैसेज और बटन में बदलाव ▼▼▼▼▼▼ -->
    <p style="font-size: 13px; color: var(--text-secondary); margin-top: 15px; margin-bottom: 5px; text-align: center;">If save fails, please restart the app to see changes.</p>
    <div style="display: flex; gap: 10px; margin-top: 10px;">
        <button type="button" class="button button-secondary" style="width: 50%;" onclick="showScreen('profile-creation-screen')">Back</button>
        <button id="final-onboarding-btn" class="button" style="width: 50%;">Finish & Find Your Spark</button>
    </div>
    <!-- ▲▲▲▲▲▲ बदलाव का अंत ▲▲▲▲▲▲ -->
</div></div>

<!-- POLICY & INFO SCREENS -->
<div id="privacy-policy-screen" class="screen"><div class="policy-layout"><header class="policy-header"><button class="back-btn" id="privacy-back-btn">←</button><h2>Privacy Policy</h2><div style="width: 40px;"></div></header><div class="policy-content" id="privacy-policy-content"></div></div></div>
<div id="terms-conditions-screen" class="screen"><div class="policy-layout"><header class="policy-header"><button class="back-btn" id="terms-back-btn">←</button><h2>Terms & Conditions</h2><div style="width: 40px;"></div></header><div class="policy-content" id="terms-conditions-content"></div></div></div>

<!-- MAIN APP SCREEN -->
<div id="main-app-screen" class="screen">
    <div class="main-app-layout">
        <header class="top-bar">
            <div class="menu-icon" onclick="toggleSideMenu()">☰</div>
            <div class="logo-container">
                <span class="logo-text">Soul</span>
                <div id="user-pic-header">U</div>
                <span class="logo-text">Spark</span>
            </div>
            <div class="dots-icon" onclick="toggleThemeModal()">⋮</div>
        </header>

        <main class="main-content">
            <div id="home-view" class="view active">
                <div class="swipe-card-container" id="swipe-card-container"></div>
                <div class="swipe-actions">
                    <button class="action-btn dislike" id="dislike-btn">✕</button>
                    <button class="action-btn-details" id="details-btn">🎁 Get to know</button>
                    <button class="action-btn like" id="like-btn">✓</button>
                </div>
            </div>

            <div id="likes-view" class="view">
                <h2>People who liked you</h2>
                <ul class="likes-list" id="likes-list"></ul>
            </div>

            <div id="messages-view" class="view">
                <h2 style="margin-bottom: 20px;">Chats</h2>
                <ul class="chat-list" id="chat-list"><p style="padding: 20px; text-align: center;">Loading your chats...</p></ul>
            </div>

             <div id="sparks-view" class="view">
                <div class="content-wrapper">
                    <div class="spark-container">
                        <h3>⭐ Daily Spark</h3>
                        <div id="spark-quiz-container">
                            <h4 id="spark-quiz-question"></h4><div id="spark-quiz-options"></div><p id="spark-quiz-result"></p>
                        </div>
                    </div>
                    <div class="spark-container">
                        <h3>💡 Date Idea Jar</h3>
                        <p>Stuck on what to do? Get a random date idea!</p>
                        <p id="date-idea-display" style="font-family: 'Caveat', cursive; font-size: 24px; color: var(--accent-color); min-height: 60px; display: flex; align-items: center; justify-content: center; border: 2px dashed var(--text-secondary); border-radius: 10px; padding: 10px;"></p>
                        <button class="button" id="get-date-idea-btn" style="margin-top: 15px;">Get New Idea</button>
                    </div>
                    <div class="spark-container">
                        <h3>💡 Tip of the Day</h3><p id="spark-tip-text" style="text-align: left; max-width: 100%;"></p>
                    </div>
                </div>
            </div>

            <div id="profile-view" class="view">
                <button class="button" id="edit-profile-btn" style="float: right; margin-top: 0; padding: 10px 20px; font-size: 14px;">Edit Profile</button>
                <h2>My Profile</h2>
                <div class="profile-completion"><div class="progress-container"><div class="progress-bar-fill" id="profile-progress-bar"></div></div></div>
                <div id="profile-view-content" style="clear: both;"></div>
                <div id="vibe-quiz-container" style="margin-top: 20px;"></div>
                <div id="achievements-section">
                    <div class="achievements-header">
                        <h4>Achievements</h4><button class="how-to-btn" id="how-to-get-btn">How to Get?</button>
                    </div>
                    <div class="achievements-grid-wrapper"><div class="achievements-grid"></div></div>
                </div>
                <div class="profile-codes-container">
                    <div id="profile-id-container">
                        <span id="profile-id-display">Your ID: <strong id="profile-id"></strong></span>
                        <button id="copy-id-btn">Copy</button>
                    </div>
                    <div id="my-referral-code-container">
                        <span id="referral-code-display">Your Referral Code: <strong id="my-referral-code"></strong></span>
                        <button id="copy-referral-btn">Copy</button>
                    </div>
                </div>
                <button class="button button-secondary" id="logout-btn" style="border-color: var(--error-color); color: var(--error-color); width: 100%; margin-top: 20px;">Log Out</button>
            </div>
        </main>
        
        <nav class="bottom-nav">
            <div id="nav-home" class="nav-item active" onclick="showView('home-view')"><svg fill="currentColor" viewBox="0 0 20 20"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"></path></svg><span>Home</span></div>
            <div id="nav-likes" class="nav-item" onclick="showView('likes-view')"><svg fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd"></path></svg><span>Likes</span><span class="nav-badge" id="likes-badge"></span></div>
            <div id="nav-messages" class="nav-item" onclick="showView('messages-view')"><svg fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 5v8a2 2 0 01-2 2h-5l-5 4v-4H4a2 2 0 01-2-2V5a2 2 0 012-2h12a2 2 0 012 2zM7 8H5v2h2V8zm2 0h2v2H9V8zm6 0h-2v2h2V8z" clip-rule="evenodd"></path></svg><span>Chats</span></div>
            <div id="nav-sparks" class="nav-item" onclick="showView('sparks-view')"><svg fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg><span>Sparks</span></div>
            <div id="nav-profile" class="nav-item" onclick="showView('profile-view')"><svg fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path></svg><span>Profile</span></div>
        </nav>
    </div>
</div>

<div class="fab" id="fab-icon">💬</div>

<div id="chat-screen" class="screen">
    <div class="chat-layout">
        <div id="bubble-background"></div>
        <header class="chat-header"><button class="back-btn" id="chat-back-btn">←</button><div class="chat-header-left"><div class="chat-header-info"><div class="chat-header-info-main"><div class="chat-avatar" id="chat-avatar-header"></div><h3 id="chat-with-name"></h3></div><span id="chat-user-status"></span></div></div><div class="chat-header-menu-icon" onclick="toggleChatMenu(true)">⋮</div></header>
        <main id="message-area"><div id="icebreaker-suggestion" onclick="useIcebreaker(this)"></div><div id="blocked-user-banner"></div></main>
        <footer class="chat-footer" id="chat-footer">
            <div class="chat-input-area">
                <button class="chat-footer-btn sticker-btn" id="sticker-btn">😀</button>
                <input type="text" id="message-input" placeholder="Type a message...">
                <button class="chat-footer-btn send-btn" id="send-btn" disabled>➤</button>
                <button class="chat-footer-btn hide-keyboard-btn" id="hide-keyboard-btn">🔙</button>
            </div>
            <div id="sticker-panel">
                <div class="sticker-tabs" id="sticker-tabs"></div>
                <div id="sticker-grid"></div>
            </div>
        </footer>
    </div>
</div>

<div id="profile-detail-screen" class="screen"><div class="chat-layout"><header class="chat-header"><div class="chat-header-left"><button class="back-btn" id="profile-detail-back-btn">←</button><h3 id="profile-detail-name">Profile Details</h3></div><div style="width: 40px;"></div></header><main id="profile-detail-content" style="flex-grow: 1; overflow-y: auto; padding: 20px;"></main></div></div>

<div id="side-menu">
    <div class="modal-header" style="margin-bottom: 20px;">
        <button class="modal-back-btn" onclick="toggleSideMenu()">←</button>
        <h3 style="color:var(--accent-color); margin: 0;">Menu</h3>
    </div>
    <div class="menu-item" id="how-to-run-app-btn">How to run app</div>
    <div class="menu-item" id="privacy-policy-menu-btn">Privacy Policy</div>
    <div class="menu-item" id="terms-conditions-menu-btn">Terms & Conditions</div>
    <div class="menu-item" id="blocked-users-menu-btn">Blocked Users</div>

    <h3 style="margin-top:20px; color:var(--accent-color);">Filters</h3>
    <div class="form-group"><label>Find by Profile ID</label><input type="text" id="filter-id" placeholder="Enter User ID"><button class="button" id="find-by-id-btn" style="font-size:12px; padding: 8px 12px; margin-top: 8px;">Find User</button></div>
    <div class="form-group"><label for="filter-city">City</label><input type="text" id="filter-city" placeholder="e.g. Delhi"></div>
    <div class="form-group"><label for="filter-age">Age Range</label><input type="range" id="filter-age" min="18" max="60" value="30"><span id="age-range-label">30 years</span></div>
    <button class="button" id="apply-filters-btn">Apply Filters</button>
</div>

<div id="theme-modal">
    <div class="modal-header" style="margin-bottom: 20px;">
        <button class="modal-back-btn" onclick="toggleThemeModal()">←</button>
        <h3 style="color:var(--accent-color); margin: 0;">Select Theme</h3>
    </div>
    <div class="menu-item" onclick="changeTheme('theme-dark')">Default Dark</div><div class="menu-item" onclick="changeTheme('theme-pink-white')">Pink & White</div><div class="menu-item" onclick="changeTheme('theme-green-white')">Green & White</div><div class="menu-item" onclick="changeTheme('theme-blue-white')">Blue & White</div><hr style="border-color: #555; margin: 10px 0;"><h4 style="text-align:center; margin-bottom: 10px;">Neon Themes</h4><div class="menu-item" onclick="changeTheme('theme-neon-blue')">Neon Blue</div><div class="menu-item" onclick="changeTheme('theme-neon-pink')">Neon Pink</div><div class="menu-item" onclick="changeTheme('theme-neon-green')">Neon Green</div><div class="menu-item" onclick="changeTheme('theme-neon-red')">Neon Red</div><div class="menu-item" onclick="changeTheme('theme-neon-orange')">Neon Orange</div><div class="menu-item" onclick="changeTheme('theme-neon-purple')">Neon Purple</div><div class="menu-item" onclick="changeTheme('theme-neon-cyan')">Neon Cyan</div><div class="menu-item" onclick="changeTheme('theme-neon-yellow')">Neon Yellow</div><div class="menu-item" onclick="changeTheme('theme-futuristic')">Futuristic</div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<script>
    // --- FIREBASE CONFIGURATION ---
    const firebaseConfig = {
        apiKey: "AIzaSyDokia-G7qUs5OkQjrwA5xxdm7ShLjJi00", // This is a dummy key. Replace with your actual Firebase config.
        authDomain: "spark-1d33a.firebaseapp.com",
        databaseURL: "https://spark-1d33a-default-rtdb.firebaseio.com",
        projectId: "spark-1d33a",
        storageBucket: "spark-1d33a.appspot.com",
        messagingSenderId: "798491973363",
        appId: "1:798491973363:web:07250fb5c14043b95bc986",
        measurementId: "G-RNT5GHRVP1"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const rtdb = firebase.database();
    const auth = firebase.auth();
    const CLOUDINARY_CLOUD_NAME = 'dtvrhjtt4';
    const CLOUDINARY_UPLOAD_PRESET = 'Soul_Spark';

    // --- DATA & STATE MANAGEMENT ---
    let userProfile = {}, blockedUsers = {}, currentFlirtLine = '', currentChattingWith = null, currentProfileImageIndex = 0, bubbleInterval = null, matches = [], fetchedProfiles = [], incomingLikes = [], currentProfileIndex = -1, isNewUserBeingCreated = false;
    let userListener = null, chatListenerUnsubscribe = null, onlineStatusListenerUnsubscribe = null, typingListenerUnsubscribe = null, likesListenerUnsubscribe = null, matchesListenerUnsubscribe = null;
    let typingTimeout = null;
    let longPressTimer;
    let pressedMessageId = null;

    const icebreakerQuestions = ["If you could have any superpower, what would it be?", "What's the most adventurous thing you've ever done?", "Coffee or chai?", "What's a skill you'd love to learn?", "What's your favorite movie of all time?"];
    const loveQuotes = [ { text: "The best thing to hold onto in life is each other.", author: "Audrey Hepburn" }, { text: "To love and be loved is to feel the sun from both sides.", author: "David Viscott" }, { text: "You know you're in love when you can't fall asleep because reality is finally better than your dreams.", author: "Dr. Seuss" }, { text: "Love is composed of a single soul inhabiting two bodies.", author: "Aristotle" }, { text: "The greatest happiness of life is the conviction that we are loved; loved for ourselves, or rather, loved in spite of ourselves.", author: "Victor Hugo" } ];
    const achievementsList = { 'profilePro': { title: 'Profile Pro', icon: '🏆', rule: 'Complete your profile to 100%.' }, 'picturePerfect': { title: 'Picture Perfect', icon: '📸', rule: 'Upload 4 profile pictures.' }, 'openBook': { title: 'Open Book', icon: '📖', rule: 'Fill out all 3 prompts about yourself.' }, 'thePoet': { title: 'The Poet', icon: '✍️', rule: 'Write a bio with over 200 characters.' }, 'selfImprover': { title: 'Self Improver', icon: '✏️', rule: 'Edit and save your profile after creation.' }, 'firstSpark': { title: 'First Spark', icon: '❤️', rule: 'Get your very first match.' }, 'heartThrob': { title: 'Heart Throb', icon: '💖', rule: 'Get 5 matches.' }, 'matchMaker': { title: 'Match Maker', icon: '✨', rule: 'Get 10 matches.' }, 'socialButterfly': { title: 'Social Butterfly', icon: '🦋', rule: 'Get 25 matches.' }, 'kingOfHearts': { title: 'King of Hearts', icon: '👑', rule: 'Get 50 matches.' }, 'theExplorer': { title: 'The Explorer', icon: '🗺️', rule: 'Swipe on 50 profiles.' }, 'globetrotter': { title: 'Globetrotter', icon: '🌍', rule: 'Swipe on 200 profiles.' }, 'convoStarter': { title: 'Chatterbox', icon: '💬', rule: 'Start conversations with 5 different people.' }, 'iceBreaker': { title: 'Ice Breaker', icon: '🧊', rule: 'Use a suggested icebreaker question.' }, 'themeChanger': { title: 'Decorator', icon: '🎨', rule: 'Change a chat theme.' }, 'loyalUser': { title: 'Loyal User', icon: '🛡️', rule: 'Log in 7 days in a row.' }, 'nightOwl': { title: 'Night Owl', icon: '🦉', rule: 'Be active on the app after midnight.' }, 'earlyBird': { title: 'Early Bird', icon: '☀️', rule: 'Be active on the app before 7 AM.' }, 'sharer': { title: 'The Sharer', icon: '🔗', rule: 'Use the "Copy ID" button.' }, 'perfectionist': { title: 'Perfectionist', icon: '💎', rule: 'Edit your profile 5 times.' }, 'friendBringer': { title: 'Friend Bringer', icon: '👋', rule: 'Successfully invite 5 friends.' }, 'partyStarter': { title: 'Party Starter', icon: '🎉', rule: 'Successfully invite 10 friends.' }, 'socialite': { title: 'Socialite', icon: '🌟', rule: 'Successfully invite 20 friends.' }, 'influencer': { title: 'Influencer', icon: '🔥', rule: 'Successfully invite 50 friends.' }, 'communityBuilder': { title: 'Community Builder', icon: '🏘️', rule: 'Successfully invite 100 friends.' }, 'legend': { title: 'Soul Spark Legend', icon: '🎖️', rule: 'Successfully invite 500 friends.' }, 'unstoppable': { title: 'Unstoppable', icon: '🚀', rule: 'Unlock 15 other achievements.' } };
    const flirtLines=[`Are you a magician? Because whenever I look at you, everyone else disappears.`,`I'm not a photographer, but I can picture us together.`,`Do you have a map? I keep getting lost in your eyes.`,`If you were a vegetable, you’d be a cute-cumber.`,`Is your name Google? Because you have everything I've been searching for.`];
    const questions = [ { text: "What's your ideal first date?", options: ["Coffee & a walk", "Fine dining", "Adventure activity", "Stay-in movie night"] }, { text: "What's more important in a relationship?", options: ["Deep Conversation", "Shared Humor", "Ambition & Goals", "Spontaneity"] }, { text: "Are you an early bird or a night owl?", options: ["Early Bird", "Night Owl", "A bit of both"] }, { text: "A perfect weekend for you is...", options: ["Relaxing at home", "Exploring a new place", "Partying with friends", "Learning a new skill"] }, { text: "How do you express affection?", options: ["Words of affirmation", "Quality time", "Gift giving", "Acts of service"] }, { text: "Which is more your style?", options: ["Mountains", "Beaches", "City Life", "Countryside"] }, { text: "What's your communication style in a conflict?", options: ["Talk it out immediately", "Need some space first", "Try to lighten the mood", "I'm a listener"] }, { text: "What are you most passionate about?", options: ["My career", "A creative hobby", "Social causes", "Family & friends"] }, { text: "A partner's most attractive quality is their...", options: ["Intelligence", "Kindness", "Sense of humor", "Confidence"] }, { text: "How spontaneous are you?", options: ["I plan everything", "I love a last-minute plan", "A bit of both", "I go with the flow"] } ];
    let currentQuestionIndex = 0;
    const allHobbies = ["Reading", "Hiking", "Gaming", "Cooking", "Movies", "Art", "Gym", "Yoga", "Traveling", "Music", "Dancing", "Photography", "Podcasts", "Investing"], allInterests = ["Technology", "Spirituality", "Politics", "Science Fiction", "Entrepreneurship", "History", "Fashion", "Finance"], allLanguages = ["Hindi", "English", "Marathi", "Bengali", "Tamil", "Telugu", "Punjabi", "Gujarati"], zodiacSigns = ["♈ Aries", "♉ Taurus", "♊ Gemini", "♋ Cancer", "♌ Leo", "♍ Virgo", "♎ Libra", "♏ Scorpio", "♐ Sagittarius", "♑ Capricorn", "♒ Aquarius", "♓ Pisces"];
    const bubbleThemes = [ { id: 'none', name: 'Default', colors: [], type: 'none' }, { id: 'love', name: 'Love', colors: ['#e91e63', '#ff80ab', '#c2185b'], type: 'neon' }, { id: 'ocean', name: 'Ocean', colors: ['#00BFFF', '#1E90FF', '#87CEEB'], type: 'neon' }, { id: 'forest', name: 'Forest', colors: ['#228B22', '#32CD32', '#006400'], type: 'neon' }, { id: 'sunset', name: 'Sunset', colors: ['#FF4500', '#FFA500', '#FFD700'], type: 'neon' }, { id: 'galaxy', name: 'Galaxy', colors: ['#4a148c', '#8e24aa', '#d500f9'], type: 'neon' }, { id: 'sakura', name: 'Sakura', colors: ['#FFC0CB', '#FFB6C1', '#DB7093'], type: 'neon' }, { id: 'minty', name: 'Minty Fresh', colors: ['#98FF98', '#AFE1AF', '#7FFFD4'], type: 'neon' }, { id: 'fire_ice', name: 'Fire & Ice', colors: ['#FF4500', '#1E90FF', '#FFD700'], type: 'neon' }, { id: 'royal_gold', name: 'Royal Gold', colors: ['#FFD700', '#F0E68C', '#BDB76B'], type: 'neon' }, { id: 'lavender', name: 'Lavender', colors: ['#E6E6FA', '#D8BFD8', '#9370DB'], type: 'neon' }, { id: 'monochrome', name: 'Monochrome', colors: ['#FFFFFF', '#D3D3D3', '#A9A9A9'], type: 'neon' }, { id: 'coffee', name: 'Coffee', colors: ['#6f4e37', '#8b5a2b', '#a0522d'], type: 'neon' }, { id: 'ruby', name: 'Ruby Red', colors: ['#E0115F', '#D2042D', '#9B111E'], type: 'neon' }, { id: 'emerald', name: 'Emerald', colors: ['#50C878', '#009B77', '#34C924'], type: 'neon' }, { id: 'sapphire', name: 'Sapphire', colors: ['#0F52BA', '#003153', '#082567'], type: 'neon' }, { id: 'peach', name: 'Peach', colors: ['#FFDAB9', '#FFCBA4', '#FFAC81'], type: 'neon' }, { id: 'teal', name: 'Teal', colors: ['#008080', '#20B2AA', '#00A0A0'], type: 'neon' } ];
    
    const compatibilityQuiz = [
        { question: "A perfect first date is:", options: { "Adventurous": "Hiking or exploring", "Intellectual": "A museum or bookstore", "Relaxed": "Coffee and a long talk", "Foodie": "Trying a new restaurant" } },
        { question: "I recharge my social battery by:", options: { "Adventurous": "Going out with friends", "Intellectual": "Reading a book or documentary", "Relaxed": "Staying home alone", "Foodie": "Cooking a comforting meal" } },
        { question: "My travel style is best described as:", options: { "Adventurous": "Backpacking and exploring off-beat places", "Intellectual": "Visiting historical sites and museums", "Relaxed": "All-inclusive resort and relaxing", "Foodie": "A culinary tour to taste local food" } },
        { question: "On a Friday night, I'm most likely:", options: { "Adventurous": "At a party or live event", "Intellectual": "In a deep conversation or debate", "Relaxed": "Watching a movie at home", "Foodie": "At a dinner party with friends" } },
        { question: "Which appeals to you more?", options: { "Adventurous": "Spontaneity and surprises", "Intellectual": "Logic and planning", "Relaxed": "Comfort and predictability", "Foodie": "Flavor and new experiences" } }
    ];
    let compatibilityQuizAnswers = {};
    let currentCompatibilityQuizIndex = 0;

    const dateIdeas = [ "Go for a walk in a scenic park.", "Try street food from a famous local spot.", "Visit a bookstore and pick out books for each other.", "Have a picnic with homemade sandwiches.", "Go to a local museum or art gallery.", "Try a pottery or painting class together.", "Go stargazing away from the city lights.", "Cook a meal together from scratch.", "Visit an animal shelter to play with pets.", "Find the best chai/coffee spot in your city." ];
    
    // --- CORE APP LOGIC ---
    function showScreen(screenId) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        const newScreen = document.getElementById(screenId);
        if (newScreen) newScreen.classList.add('active');
        const fab = document.getElementById('fab-icon');

        if (screenId === 'main-app-screen' || screenId === 'chat-screen') {
            fab.style.display = 'flex'; 
        } else {
            fab.style.display = 'none'; 
        }

        if (screenId === 'chat-screen') {
            fab.innerHTML = '🎮';
            fab.onclick = openGameSelection;
        } else {
            fab.innerHTML = '💬';
            fab.onclick = showFlirtLines;
        }

        if (screenId === 'privacy-policy-screen' && !document.getElementById('privacy-policy-content').innerHTML) { document.getElementById('privacy-policy-content').innerHTML = `<p><strong>Last Updated:</strong> June 11, 2025</p><hr><p>Your privacy is important to us. This Privacy Policy explains how Soul Spark (“we,” “us,” or “our”) collects, uses, shares, and protects information about you when you use our mobile application.</p><h4>1. Information We Collect</h4><p>We collect information that you provide directly to us when you use our app. This may include:</p><ul><li><strong>Profile Information:</strong> Your name, age, gender, profile picture, and other details you add to your profile.</li><li><strong>User Content:</strong> Photos, text in your "About Me" section, and other content you post on the app.</li><li><strong>Communications:</strong> When you contact us for support (e.g., at udbhavscience12@gmail.com), we may collect the information you provide in your communication.</li><li><strong>Chat History:</strong> We store your chat messages with other users to provide the messaging service.</li></ul><h4>2. How We Use Your Information</h4><p>We use the information we collect for the following purposes:</p><ul><li>To create and manage your account and profile.</li><li>To provide, maintain, and improve our services, including the matchmaking and chat features.</li><li>To enable you to communicate with other users.</li><li>To monitor and analyze trends, usage, and activities in connection with our app.</li><li>To enforce our Terms and Conditions and prevent prohibited or illegal activities.</li></ul><h4>3. How We Share Your Information</h4><p>Your privacy is a priority. We do not sell or rent your personal data to third parties. We will not share your personal data with any third party without your consent, except in the following limited circumstances:</p><ul><li><strong>With Other Users:</strong> Your public profile information will be visible to other users of the app.</li><li><strong>For Legal Reasons:</strong> We may disclose your information if required to do so by law or in response to a valid request from a law enforcement or government agency.</li></ul><h4>4. Data Security</h4><p>We implement reasonable technical and organizational safeguards to protect your data from loss, theft, misuse, and unauthorized access. However, no security system is impenetrable, and we cannot guarantee the absolute security of your information.</p><h4>5. Your Choices and Rights</h4><ul><li><strong>Account Information:</strong> You can review and update your profile information at any time through your account settings.</li><li><strong>Account Deletion:</strong> You can request to delete your account at any time. You can do this through the app settings or by contacting us at udbhavscience12@gmail.com. When you delete your account, we will take steps to remove your personal data from our active systems.</li><li><strong>Block Users:</strong> You can block other users to prevent them from contacting you.</li></ul><h4>6. Children's Privacy</h4><p>Our service is not directed to individuals under the age of 18. We do not knowingly collect personal information from children under 18. If we become aware that a child under 18 has provided us with personal information, we will take steps to delete such information.</p><h4>7. Changes to This Privacy Policy</h4><p>We may update this Privacy Policy from time to time. If we make major changes, we will notify you within the app or by other means. We encourage you to review this policy periodically.</p><h4>8. Contact Us</h4><p>If you have any questions about this Privacy Policy, please contact us at: udbhavscience12@gmail.com</p>`; }
        if (screenId === 'terms-conditions-screen' && !document.getElementById('terms-conditions-content').innerHTML) { document.getElementById('terms-conditions-content').innerHTML = `<p><strong>Last Updated:</strong> June 11, 2025</p><hr><p>Welcome to Soul Spark! These terms and conditions outline the rules and regulations for the use of the Soul Spark mobile application. By accessing or using our app, you agree to comply with and be bound by these terms. If you disagree with any part of these terms, please do not use our app.</p><h4>1. Eligibility</h4><p>You must be at least 18 years of age to create an account on Soul Spark and use its services. By creating an account, you represent and warrant that you are at least 18 years old and have the legal capacity to enter into this agreement.</p><h4>2. User Accounts</h4><ul><li>You are responsible for maintaining the confidentiality of your account and for all activities that occur under your account.</li><li>You agree to provide accurate, current, and complete information during the registration process and to update such information to keep it accurate.</li><li>You may not create more than one account for yourself.</li></ul><h4>3. User Conduct and Content (User-Generated Content)</h4><p>You are solely responsible for the content you publish or display on the app, or transmit to other users. You agree not to post, upload, or share any content that:</p><ul><li>Is sexually explicit, pornographic, or contains nudity.</li><li>Is abusive, threatening, harassing, defamatory, or libelous.</li><li>Promotes racism, bigotry, hatred, or physical harm of any kind against any group or individual.</li><li>Is false, misleading, or promotes illegal activities.</li><li>Involves the transmission of “junk mail,” “chain letters,” or unsolicited mass mailing or “spamming.”</li></ul><p>We reserve the right to investigate and take appropriate legal action against anyone who violates this provision, including removing the offending content and terminating the account of such violators.</p><h4>4. Safety and Interactions with Other Users</h4><ul><li>Soul Spark provides features that allow you to block and unblock other users at any time.</li><li>You can report any user or content that violates our policies by contacting us at udbhavscience12@gmail.com. We will review your report and take appropriate action, which may include suspending or permanently banning the reported user's account.</li><li>You are solely responsible for your interactions with other users. Soul Spark is not responsible for the conduct of any user.</li></ul><h4>5. Account Termination</h4><p>We may terminate or suspend your account at any time, without notice, for conduct that we believe violates these Terms and Conditions, or is otherwise harmful to other users of the app or to our interests.</p><h4>6. Service Availability</h4><p>We do not guarantee that the app will be available at all times. We reserve the right to modify, suspend, or discontinue the service at any time without notice.</p><h4>7. Governing Law</h4><p>These terms shall be governed in accordance with the laws of India, without regard to its conflict of law provisions.</p><h4>8. Changes to Terms</h4><p>We reserve the right to modify these terms at any time. We will notify you of any major changes by a notification within the app. Your continued use of the app after such changes constitutes your acceptance of the new terms.</p><h4>9. Contact Us</h4><p>If you have any questions about these Terms, please contact us at: udbhavscience12@gmail.com</p>`; }
    }
    function showView(viewId) { document.querySelectorAll('.view').forEach(v => v.classList.remove('active')); const newView = document.getElementById(viewId); if(newView) newView.classList.add('active'); document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active')); const navItem = document.getElementById('nav-' + viewId.replace('-view', '')); if (navItem) navItem.classList.add('active'); if (viewId === 'likes-view') { const badge = document.getElementById('likes-badge'); badge.style.display = 'none'; badge.textContent = ''; } if (viewId === 'explore-view' && document.getElementById('explore-grid').innerHTML === '') { populateExploreView(); } if (viewId === 'sparks-view' && !document.getElementById('spark-tip-text').textContent) { initializeSparksView(); } }
    
    function openUploadWidget(options, callback) {
        const uploadBtn = document.getElementById('upload_widget_profile');
        const originalText = uploadBtn.textContent;
        uploadBtn.disabled = true;
        uploadBtn.textContent = 'Loading...';

        const myWidget = cloudinary.createUploadWidget({ cloudName: CLOUDINARY_CLOUD_NAME, uploadPreset: CLOUDINARY_UPLOAD_PRESET, ...options }, (error, result) => { 
            if (result.event === 'close') {
                uploadBtn.disabled = false;
                uploadBtn.textContent = originalText;
            }
            if (!error && result && result.event === "success") {
                 callback(result.info);
            } else if (error) { 
                console.error("Cloudinary Error: ", error); 
                uploadBtn.disabled = false;
                uploadBtn.textContent = originalText;
            } 
        }); 
        myWidget.open(); 
    }
    
    function startOnboarding(){
        currentCompatibilityQuizIndex = 0;
        compatibilityQuizAnswers = {};
        showScreen("compatibility-quiz-screen");
        displayCompatibilityQuestion();
    }

    function updateProfilePicsPreview(){const e=document.getElementById("profile-pics-preview");if(e.innerHTML="",userProfile.pictures&&userProfile.pictures.length>0)userProfile.pictures.forEach(((t,o)=>{const i=document.createElement("div");i.style.position="relative";const s=t.replace("/upload/","/upload/w_100,h_100,c_fill,g_face,r_max/");i.innerHTML=`<img src="${s}" style="width: 80px; height: 80px; object-fit: cover; border-radius: 8px;"><span onclick="removeProfilePic(${o})" style="position: absolute; top: -5px; right: -5px; background: var(--error-color); color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 12px; border: 1px solid var(--primary-bg);">X</span>`,e.appendChild(i)}));else e.innerHTML='<p style="color: var(--text-secondary); font-size: 14px; text-align: center; width: 100%;">Upload your photos here</p>'}
    function removeProfilePic(e){confirm("Are you sure you want to remove this picture?")&&(userProfile.pictures.splice(e,1),updateProfilePicsPreview())}
    function displayQuestion(){if(currentQuestionIndex>=questions.length)return void skipToZodiac();const e=questions[currentQuestionIndex];document.getElementById("question-text").textContent=e.text;const t=document.getElementById("question-options");t.innerHTML="",e.options.forEach((e=>{const o=document.createElement("div");o.className="question-option",o.textContent=e,o.onclick=()=>{userProfile[`question_${currentQuestionIndex}`]=e,currentQuestionIndex++,updateProgressBar(),displayQuestion()},t.appendChild(o)}))}
    function updateProgressBar(){const e=currentQuestionIndex/questions.length*100;document.getElementById("progress-bar").style.width=`${e}%`}
    function populateTags(e,t){const o=document.getElementById(e);o.innerHTML="",t.forEach((e=>{const t=document.createElement("span");t.className="hobby-tag",t.textContent=e,t.onclick=()=>t.classList.toggle("selected"),o.appendChild(t)}))}
    function populateZodiacs(){const e=document.getElementById("zodiac-grid");zodiacSigns.forEach((t=>{const o=document.createElement("div");o.className="zodiac-item",o.textContent=t,o.onclick=e=>{document.querySelectorAll(".zodiac-item").forEach((e=>e.classList.remove("selected"))),e.target.classList.add("selected")},e.appendChild(o)}))}
    function skipToZodiac(){showScreen("zodiac-screen")}
    function proceedToReferral(e=!1){if(e)userProfile.zodiac="Not specified";else{const e=document.querySelector(".zodiac-item.selected");if(!e)return void alert("Please select a zodiac sign or press Skip.");userProfile.zodiac=e.textContent}showScreen("referral-screen")}
    async function handleReferral(skip = false) { if (skip) { userProfile.referredBy = null; showScreen('profile-creation-screen'); return; } const code = document.getElementById('referral-code').value.trim().toUpperCase(); if (!code) { alert("Please enter a referral code or press Skip."); return; } try { const querySnapshot = await db.collection('users').where('referralCode', '==', code).limit(1).get(); if (querySnapshot.empty) { alert('Invalid referral code. Please check the code or skip.'); userProfile.referredBy = null; } else { const referrerDoc = querySnapshot.docs[0]; userProfile.referredBy = referrerDoc.id; alert('Referral code accepted!'); } showScreen('profile-creation-screen'); } catch (error) { console.error("Error verifying referral code:", error); alert("Could not verify referral code. Please try again or skip."); userProfile.referredBy = null; showScreen('profile-creation-screen');} }
    function validateAndProceedToDetails(){ const dobInput = document.getElementById('dob').value; if (!dobInput) { alert("Please enter your Date of Birth."); return false; } if (calculateAge(dobInput) < 18) { showCustomAlert("Age Restriction", "Sorry, you must be 18 years or older to use Soul Spark.", "💔"); return false; } let isValid = true; ["name","email","password","mobile","city","state","bio"].forEach((id) => { const input = document.getElementById(id); if (input.value.trim() === "") { alert(`Please fill in your ${id}.`); input.classList.add("error"); isValid = false; } else { input.classList.remove("error"); } }); if (!userProfile.pictures || userProfile.pictures.length === 0) { alert("Please upload at least one profile picture."); isValid = false; } if (isValid) showScreen("details-screen"); }
    function validateDetailsAndFinish(){let e=!0;const t=document.getElementById("profession");return""===t.value.trim()?(alert("Please fill in your profession."),t.classList.add("error"),e=!1):t.classList.remove("error"),0===document.querySelectorAll("#hobbies-profile .selected").length&&(alert("Please select at least one hobby."),e=!1),0===document.querySelectorAll("#interests-details .selected").length&&(alert("Please select at least one interest."),e=!1),e}
    async function saveProfileToFirestore(e){e.id?await db.collection("users").doc(e.id).set(e,{merge:!0}):console.error("No user ID found to save profile.")}
    function gatherDataFromForms(){userProfile.name=document.getElementById("name").value,userProfile.email=document.getElementById("email").value,userProfile.mobile=document.getElementById("mobile").value,userProfile.dob=document.getElementById("dob").value,userProfile.gender=document.getElementById("gender").value,userProfile.city=document.getElementById("city").value,userProfile.state=document.getElementById("state").value,userProfile.bio=document.getElementById("bio").value,userProfile.prompt1=document.getElementById("prompt1").value,userProfile.prompt2=document.getElementById("prompt2").value,userProfile.prompt3=document.getElementById("prompt3").value,userProfile.height=document.getElementById("height").value,userProfile.religion=document.getElementById("religion").value,userProfile.homeTown=document.getElementById("homeTown").value,userProfile.workplaceCity=document.getElementById("workplaceCity").value,userProfile.education=document.getElementById("education").value,userProfile.profession=document.getElementById("profession").value,userProfile.drinking=document.getElementById("drinking").value,userProfile.smoking=document.getElementById("smoking").value,userProfile.diet=document.getElementById("diet").value,userProfile.hobbies=Array.from(document.querySelectorAll("#hobbies-profile .selected")).map((e=>e.textContent)),userProfile.interests=Array.from(document.querySelectorAll("#interests-details .selected")).map((e=>e.textContent)),userProfile.languages=Array.from(document.querySelectorAll("#language-tags .selected")).map((e=>e.textContent)); userProfile.vibe = document.getElementById('profile-vibe').value; userProfile.pictures||(userProfile.pictures=[])}
    async function loginUser(){ const e=document.getElementById("login-email").value,t=document.getElementById("login-password").value; if (!e || !t) { alert("Please enter both email and password."); return; } try { await auth.signInWithEmailAndPassword(e,t); } catch(error) { console.error("Login failed:",error); alert("Login failed: "+error.message) } }
    
    // ▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼
    // ===== यहाँ मैंने आपके दोनों फंक्शन को बेहतर और सुरक्षित बनाया है =====
    // ▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼
    
    async function finishOnboarding() {
        const btn = document.getElementById('final-onboarding-btn');
        if(!validateDetailsAndFinish()) return; 

        btn.textContent = 'Saving...';
        const email = document.getElementById("email").value;
        const password = document.getElementById("password").value;
        
        try { 
            const userCredential = await auth.createUserWithEmailAndPassword(email, password);
            const user = userCredential.user;
            
            // isNewUserBeingCreated को यहाँ true सेट करने की ज़रूरत नहीं, 
            // क्योंकि हम अब onAuthStateChanged का इंतज़ार नहीं कर रहे हैं।
            
            gatherDataFromForms(); 
            userProfile.id = user.uid; 
            userProfile.displayId = "SS-" + Math.random().toString(36).substring(2,8).toUpperCase(); 
            userProfile.referralCode = "SPARK-" + user.uid.substring(0, 6).toUpperCase(); 
            userProfile.achievements = {}; 
            for (const key in achievementsList) { userProfile.achievements[key] = false; } 
            userProfile.stats = {'matchesCount':0, 'swipesCount': 0, 'conversationsStarted':[], 'editCount': 0, 'loginStreak': 1, 'lastLogin': new Date().toISOString().slice(0, 10), 'referralCount': 0}; 
            userProfile.blockedUsers = {}; 
            userProfile.blockedBy = {}; 
            if (userProfile.referredBy) { await db.collection('users').doc(userProfile.referredBy).update({ 'stats.referralCount': firebase.firestore.FieldValue.increment(1) }); } 
            
            await saveProfileToFirestore(userProfile); 
            checkAllAchievements(userProfile);
            
            // समाधान: नया यूज़र बनने के बाद, सीधे होम पेज पर जाएं।
            await setupAppAfterLogin(userProfile);

        } catch(error) { 
            console.error("Error during onboarding:", error); 
            if (error.code === 'auth/email-already-in-use') {
                alert("This email address is already in use by another account.");
            } else {
                alert("Could not create account: " + error.message);
            }
        } finally {
            btn.textContent = 'Finish & Find Your Spark';
        }
    }
    
    function populateProfileView(){ 
        const e=document.getElementById("profile-view-content"); 
        const vibeQuizContainer = document.getElementById('vibe-quiz-container'); 
        if(e && userProfile && userProfile.name){ 
            let t="";
            userProfile.pictures&&userProfile.pictures.length>0&&(t='<h4>Pictures</h4><div class="avatar-grid">',userProfile.pictures.forEach((e=>{t+=`<img src="${e.replace("/upload/","/upload/w_150,h_150,c_fill,g_face,r_8/")}" style="width: 100px; height: 100px; object-fit: cover; border-radius: 8px;">`})),t+="</div>"); 
            const personalityVibe = userProfile.quizResult ? `<div class="vibe-badge">Your Vibe: ${userProfile.quizResult}</div>` : ''; 
            e.innerHTML=`${personalityVibe}<h4>Bio</h4><p style="text-align: left;">${userProfile.bio||"No bio provided."}</p>${userProfile.prompt1?`<h4>My simple pleasures...</h4><p style="text-align: left;">${userProfile.prompt1}</p>`:""}${userProfile.prompt2?`<h4>I'm looking for...</h4><p style="text-align: left;">${userProfile.prompt2}</p>`:""}${userProfile.prompt3?`<h4>My perfect Sunday...</h4><p style="text-align: left;">${userProfile.prompt3}</p>`:""}${t}<h4>Details</h4><ul class="details-list" style="list-style-type: none; padding-left: 0;">${userProfile.height?`<li><strong>Height:</strong> ${userProfile.height}</li>`:""}${userProfile.religion?`<li><strong>Religion:</strong> ${userProfile.religion}</li>`:""}${userProfile.homeTown?`<li><strong>Home Town:</strong> ${userProfile.homeTown}</li>`:""}${userProfile.workplaceCity?`<li><strong>Workplace:</strong> ${userProfile.workplaceCity}</li>`:""}${Array.isArray(userProfile.languages)&&userProfile.languages.length>0?`<li><strong>Languages:</strong> ${userProfile.languages.join(", ")}</li>`:""}${userProfile.zodiac?`<li><strong>Zodiac:</strong> ${userProfile.zodiac}</li>`:""}${userProfile.education?`<li><strong>Education:</strong> ${userProfile.education}</li>`:""}${userProfile.profession?`<li><strong>Profession:</strong> ${userProfile.profession}</li>`:""}${userProfile.drinking?`<li><strong>Lifestyle:</strong> ${userProfile.drinking} drinker, ${userProfile.smoking} smoker.</li>`:""}${userProfile.diet?`<li><strong>Diet:</strong> ${userProfile.diet}</li>`:""}</ul><h4>Hobbies</h4><p style="text-align: left;">${Array.isArray(userProfile.hobbies)&&userProfile.hobbies.length>0?userProfile.hobbies.join(", "):"No hobbies listed."}</p><h4>Interests</h4><p style="text-align: left;">${Array.isArray(userProfile.interests)&&userProfile.interests.length>0?userProfile.interests.join(", "):"No interests listed."}</p>`; 
            document.getElementById("profile-id").textContent=userProfile.displayId||"N/A"; 
            document.getElementById("my-referral-code").textContent=userProfile.referralCode||"N/A"; 
        } 
        if(vibeQuizContainer){ 
            if(!userProfile.quizResult){ 
                vibeQuizContainer.innerHTML = `<button class="button" id="take-vibe-quiz-btn">Take the Vibe Quiz!</button>`; 
                document.getElementById('take-vibe-quiz-btn').onclick = () => startCompatibilityQuiz(userProfile); 
            } else { 
                vibeQuizContainer.innerHTML = ''; 
            } 
        } 
        updateAchievements(); 
        checkProfileCompletion(); 
        checkReferralAchievements(userProfile); 
    }
    
    async function saveProfileChanges() {
        // फॉर्म से नया डेटा इकट्ठा किया
        gatherDataFromForms(); 
        userProfile.stats.editCount = (userProfile.stats?.editCount || 0) + 1;
        
        try {
            // सर्वर पर डेटा भेजा
            await saveProfileToFirestore(userProfile);
            
            // अचीवमेंट और दूसरी चीज़ें अपडेट कीं
            unlockAchievement('selfImprover');
            if (userProfile.stats.editCount >= 5) {
                unlockAchievement('perfectionist');
            }
            checkAllAchievements(userProfile);
            
            // समाधान: स्क्रीन को नए डेटा से तुरंत रीफ्रेश किया
            populateProfileView(); 
            
            showAutoHidePopup("Profile Saved Successfully!", "✅");
            
            // वापस प्रोफाइल व्यू पर ले गए
            showScreen("main-app-screen");
            showView("profile-view");

        } catch (error) {
            console.error("Error saving profile:", error);
            showAutoHidePopup("Could not save profile. Please try again.", "❌");
        }
    }
    
    // ▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲
    // ===== बदलाव का अंत =====
    // ▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲

    async function logoutUser(){ if(confirm("Are you sure you want to log out?")) { if (auth.currentUser) { await rtdb.ref('/status/' + auth.currentUser.uid).set({ isOnline: false, last_changed: firebase.database.ServerValue.TIMESTAMP }); } await auth.signOut(); } }
    function calculateAge(e){if(!e)return 0;const t=new Date(e),o=new Date;let i=o.getFullYear()-t.getFullYear();const s=o.getMonth()-t.getMonth();return(s<0||0===s&&o.getDate()<t.getDate())&&i--,i}
    async function initializeAndCheckUserData(profile) { if (!profile) return; const updates = {}; if (!profile.stats) { updates.stats = { matchesCount: 0, swipesCount: 0, conversationsStarted:[], editCount: 0, loginStreak: 1, lastLogin: new Date().toISOString().slice(0, 10), referralCount: 0 }; } else { const today = new Date().toISOString().slice(0, 10); const lastLogin = profile.stats.lastLogin; if (today !== lastLogin) { const lastLoginDate = new Date(lastLogin); const todayDate = new Date(today); const diffTime = todayDate - lastLoginDate; const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); updates['stats.loginStreak'] = (diffDays === 1) ? (profile.stats.loginStreak || 1) + 1 : 1; updates['stats.lastLogin'] = today; if (updates['stats.loginStreak'] >= 7) unlockAchievement('loyalUser'); } } if (!profile.referralCode) { updates.referralCode = "SPARK-" + profile.id.substring(0, 6).toUpperCase(); } if (!profile.blockedUsers) { updates.blockedUsers = {}; } if (!profile.blockedBy) { updates.blockedBy = {}; } if (!profile.vibe) { updates.vibe = 'default'; } if (Object.keys(updates).length > 0) { await db.collection('users').doc(profile.id).update(updates); const updatedDoc = await db.collection('users').doc(profile.id).get(); return updatedDoc.data(); } return profile; }
    function cleanupListeners() { if (userListener) { userListener(); userListener = null; } if (chatListenerUnsubscribe) { chatListenerUnsubscribe(); chatListenerUnsubscribe = null; } if (onlineStatusListenerUnsubscribe) { rtdb.ref(onlineStatusListenerUnsubscribe).off(); onlineStatusListenerUnsubscribe = null; } if (typingListenerUnsubscribe) { rtdb.ref(typingListenerUnsubscribe).off(); typingListenerUnsubscribe = null; } if (likesListenerUnsubscribe) { likesListenerUnsubscribe(); likesListenerUnsubscribe = null; } if (matchesListenerUnsubscribe) { matchesListenerUnsubscribe(); matchesListenerUnsubscribe = null; } }
    async function setupAppAfterLogin(profileData) { if (!profileData.id) return; if (!profileData.quizResult && auth.currentUser.uid === profileData.id) { startCompatibilityQuiz(profileData); return; } userProfile = await initializeAndCheckUserData(profileData); blockedUsers = userProfile.blockedUsers || {}; const headerPic = document.getElementById('user-pic-header'); if (userProfile.pictures && userProfile.pictures.length > 0) { headerPic.innerHTML = `<img src="${userProfile.pictures[0].replace('/upload/','/upload/w_40,h_40,c_fill,g_face/')}" alt="P">`; } else { const initial = userProfile.name ? userProfile.name.charAt(0).toUpperCase() : 'U'; headerPic.textContent = initial; } await setupPresenceSystem(); setupRealtimeListeners(); await fetchUsersFromFirestore(); showScreen('main-app-screen'); showView('home-view'); document.getElementById('loading-screen').classList.remove('active'); }
    function initializeApp() {
        document.getElementById('loading-screen').classList.add('active');
        auth.onAuthStateChanged(async (user) => {
            // isNewUserBeingCreated को हटा दिया गया है क्योंकि अब इसकी ज़रूरत नहीं।
            cleanupListeners(); 
            if (user) { 
                try { 
                    const userDoc = await db.collection('users').doc(user.uid).get(); 
                    if (!userDoc.exists) { 
                        document.getElementById('loading-screen').classList.remove('active'); 
                        showScreen('welcome-screen'); 
                        startOnboarding(); 
                        return; 
                    } 
                    await setupAppAfterLogin(userDoc.data()); 
                } catch (error) { 
                    console.error("Error during app initialization:", error); 
                    await logoutUser(); 
                } 
            } else { 
                document.getElementById('loading-screen').classList.remove('active'); 
                userProfile = {}; 
                matches = []; 
                incomingLikes = []; 
                showScreen('welcome-screen'); 
            } 
        });
        const buttonMappings = { 'get-started-btn': startOnboarding, 'welcome-login-link': () => showScreen('login-screen'), 'login-btn': loginUser, 'login-back-btn': () => showScreen('welcome-screen'), 'skip-questions-btn': skipToZodiac, 'zodiac-continue-btn': () => proceedToReferral(), 'zodiac-skip-btn': () => proceedToReferral(true), 'referral-submit-btn': () => handleReferral(), 'referral-skip-btn': () => handleReferral(true), 'profile-next-btn': validateAndProceedToDetails, 'final-onboarding-btn': finishOnboarding, 'privacy-back-btn': () => showScreen('main-app-screen'), 'terms-back-btn': () => showScreen('main-app-screen'), 'dislike-btn': () => handleSwipeAction('dislike'), 'details-btn': () => showProfileDetails(), 'like-btn': () => handleSwipeAction('like'), 'edit-profile-btn': editProfile, 'how-to-get-btn': showAchievementsInfo, 'copy-id-btn': copyProfileId, 'copy-referral-btn': copyReferralCode, 'logout-btn': logoutUser, 'send-btn': ()=>{sendMessage()}, 'profile-detail-back-btn': () => showScreen('main-app-screen'), 'privacy-policy-menu-btn': () => showScreen('privacy-policy-screen'), 'terms-conditions-menu-btn': () => showScreen('terms-conditions-screen'), 'blocked-users-menu-btn': openBlockedUsersModal, 'find-by-id-btn': findById, 'apply-filters-btn': applyFilters, 'copy-flirt-btn': () => handleFlirtChoice(true), 'cancel-flirt-btn': () => handleFlirtChoice(false), 'report-user-btn': reportCurrentUser, 'chat-block-option': blockUser, 'chat-mismatch-btn': ()=>confirmMismatch(), 'get-date-idea-btn': showRandomDateIdea, 'game-two-truths-btn': () => sendGameRequest('TwoTruths'), 'sticker-btn': toggleStickerPanel, 'hide-keyboard-btn': () => { document.activeElement.blur(); }, 'how-to-run-app-btn': openTutorial };
        for(const [id, func] of Object.entries(buttonMappings)) { const btn = document.getElementById(id); if (btn) btn.addEventListener('click', func); }
        document.getElementById('upload_widget_profile').addEventListener('click', (e) => { e.preventDefault(); if ((userProfile.pictures && userProfile.pictures.length >= 4)) { alert("You can upload a maximum of 4 pictures."); return; } openUploadWidget({ multiple: true, maxFiles: 4 - (userProfile.pictures ? userProfile.pictures.length : 0), cropping: true, croppingAspectRatio: 1, sources: ['local', 'camera', 'url', 'instagram', 'facebook']}, (info) => { if (!userProfile.pictures) { userProfile.pictures = []; } if (userProfile.pictures.length < 4) { userProfile.pictures.push(info.secure_url); updateProfilePicsPreview(); }}); });
        document.getElementById('chat-back-btn').addEventListener('click', () => { if (chatListenerUnsubscribe) { chatListenerUnsubscribe(); chatListenerUnsubscribe = null; } if (onlineStatusListenerUnsubscribe) { rtdb.ref(onlineStatusListenerUnsubscribe).off(); onlineStatusListenerUnsubscribe = null; } if (typingListenerUnsubscribe) { rtdb.ref(typingListenerUnsubscribe).off(); typingListenerUnsubscribe = null; } showScreen('main-app-screen'); showView('messages-view'); });
        document.getElementById('message-input').addEventListener('input', handleTyping);
        document.getElementById('filter-age').addEventListener('input', (e) => { document.getElementById('age-range-label').textContent = `${e.target.value} years`; });
        window.addEventListener('keydown', (e) => { if (e.key === 'Enter' && document.getElementById('chat-screen').classList.contains('active')) { e.preventDefault(); document.getElementById('send-btn').click(); } else if (document.getElementById('home-view').classList.contains('active')) { if (e.key === 'ArrowLeft') { document.getElementById('dislike-btn').click(); } else if (e.key === 'ArrowRight') { document.getElementById('like-btn').click(); } } });
        document.getElementById('tutorial-language-selector').addEventListener('change', (e) => renderTutorialPage(e.target.value, currentTutorialPage));
        document.getElementById('tutorial-next-btn').addEventListener('click', () => { currentTutorialPage++; renderTutorialPage(document.getElementById('tutorial-language-selector').value, currentTutorialPage); });
        document.getElementById('tutorial-back-btn').addEventListener('click', () => { currentTutorialPage--; renderTutorialPage(document.getElementById('tutorial-language-selector').value, currentTutorialPage); });
        populateTags('hobbies-profile', allHobbies); populateTags('interests-details', allInterests); populateTags('language-tags', allLanguages); populateZodiacs();
    }
    initializeApp();

    async function handleSwipeAction(type) { const cards = document.querySelectorAll('.swipe-card-container .swipe-card'); if (cards.length === 0 || !cards[0].id.startsWith('profile-card-')) return; const swipedProfile = fetchedProfiles[currentProfileIndex]; if (!swipedProfile) return; document.getElementById('like-btn').disabled = true; document.getElementById('dislike-btn').disabled = true; try { const newSwipeCount = (userProfile.stats?.swipesCount || 0) + 1; userProfile.stats.swipesCount = newSwipeCount; db.collection('users').doc(userProfile.id).update({ 'stats.swipesCount': newSwipeCount }); if (newSwipeCount >= 50) unlockAchievement('theExplorer'); if (newSwipeCount >= 200) unlockAchievement('globetrotter'); if (type === 'like') { const theyLikeMe = incomingLikes.some(like => like.id === swipedProfile.id); if (theyLikeMe) { await createMutualMatch(swipedProfile); showMatchModal(swipedProfile); } else { await sendLike(swipedProfile); } } const topCard = cards[0]; const direction = type === 'like' ? 1 : -1; topCard.style.transform = `translateX(${direction * 100}vw) rotate(${direction * 15}deg)`; topCard.style.opacity = '0'; setTimeout(() => { loadNextProfile(); }, 500); } catch (error) { console.error("Error during swipe action:", error); showAutoHidePopup("Something went wrong, please try again.", "⚙️"); document.getElementById('like-btn').disabled = false; document.getElementById('dislike-btn').disabled = false; } }
    async function sendLike(likedProfile) { if (!auth.currentUser) return; const myId = auth.currentUser.uid; const theirId = likedProfile.id; const likeDoc = { name: userProfile.name, picture: (userProfile.pictures && userProfile.pictures.length > 0) ? userProfile.pictures[0] : null, likedAt: firebase.firestore.FieldValue.serverTimestamp() }; await db.collection('users').doc(theirId).collection('incoming_likes').doc(myId).set(likeDoc); showAutoHidePopup(`You liked ${likedProfile.name}!`, '❤️'); }
    async function createMutualMatch(matchedProfile) { if (!auth.currentUser || !userProfile) return; const myId = auth.currentUser.uid; const theirId = matchedProfile.id; try { const chatId = getChatId(myId, theirId); const chatRef = db.collection('chats').doc(chatId); await chatRef.set({ participants: [myId, theirId], creationTime: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true }); const batch = db.batch(); const myMatchData = { id: theirId, name: matchedProfile.name, picture: (matchedProfile.pictures && matchedProfile.pictures.length > 0) ? matchedProfile.pictures[0] : null, matchedAt: firebase.firestore.FieldValue.serverTimestamp() }; const theirMatchData = { id: myId, name: userProfile.name, picture: (userProfile.pictures && userProfile.pictures.length > 0) ? userProfile.pictures[0] : null, matchedAt: firebase.firestore.FieldValue.serverTimestamp() }; const myMatchRef = db.collection('users').doc(myId).collection('matches').doc(theirId); batch.set(myMatchRef, myMatchData); const theirMatchRef = db.collection('users').doc(theirId).collection('matches').doc(myId); batch.set(theirMatchRef, theirMatchData); const myIncomingLikeRef = db.collection('users').doc(myId).collection('incoming_likes').doc(theirId); batch.delete(myIncomingLikeRef); const myUserRef = db.collection('users').doc(myId); const newMatchCount = (userProfile.stats?.matchesCount || 0) + 1; batch.update(myUserRef, { 'stats.matchesCount': newMatchCount }); await batch.commit(); if (newMatchCount >= 1) unlockAchievement('firstSpark'); if (newMatchCount >= 5) unlockAchievement('heartThrob'); if (newMatchCount >= 10) unlockAchievement('matchMaker'); if (newMatchCount >= 25) unlockAchievement('socialButterfly'); if (newMatchCount >= 50) unlockAchievement('kingOfHearts'); } catch (error) { console.error("CRITICAL ERROR in createMutualMatch:", error); showAutoHidePopup("Failed to create match. Please try again.", "💔"); throw error; } }
    async function handleLikeDecision(likerProfile, accepted, listItemElement) { if (!auth.currentUser) return; const buttons = listItemElement.querySelectorAll('button'); buttons.forEach(btn => btn.disabled = true); try { if (accepted) { await createMutualMatch(likerProfile); showMatchModal(likerProfile); } else { await db.collection('users').doc(auth.currentUser.uid).collection('incoming_likes').doc(likerProfile.id).delete(); showAutoHidePopup(`Declined ${likerProfile.name}.`, '👍'); } listItemElement.style.opacity = '0'; setTimeout(() => { listItemElement.remove(); const likesList = document.getElementById('likes-list'); if (likesList.children.length === 0) { likesList.innerHTML = '<p style="padding: 20px; text-align: center;">No new likes yet. Your profile is out there!</p>'; } }, 300); } catch (error) { console.error("Error handling like decision:", error); showAutoHidePopup("Something went wrong. Please try again.", "⚙️"); buttons.forEach(btn => btn.disabled = false); } }
    function showMatchModal(matchedProfile) { const modal = document.getElementById('match-modal'); document.getElementById('match-modal-text').textContent = `You and ${matchedProfile.name} have liked each other!`; const myPic = (userProfile.pictures && userProfile.pictures.length > 0) ? userProfile.pictures[0] : 'https://via.placeholder.com/80'; const theirPic = (matchedProfile.pictures && matchedProfile.pictures.length > 0) ? matchedProfile.pictures[0] : 'https://via.placeholder.com/80'; document.getElementById('match-avatars').innerHTML = `<img src="${myPic}" alt="My Avatar" class="avatar avatar1"><div class="modal-heart">❤️</div><img src="${theirPic}" alt="${matchedProfile.name}'s Avatar" class="avatar avatar2">`; const chatBtn = document.getElementById('match-modal-chat-btn'); chatBtn.onclick = () => { modal.classList.remove('active'); openChatWindow(matchedProfile); showView('messages-view'); }; modal.classList.add('active'); }
    
    function loadNextProfile() {
        currentProfileIndex++;
        const container = document.getElementById('swipe-card-container');
        
        if (container.children.length === 0) {
            container.innerHTML = '';
            const profilesToShow = fetchedProfiles.slice(currentProfileIndex, currentProfileIndex + 3);
            if (profilesToShow.length > 0) {
                profilesToShow.forEach(profile => {
                    const card = createProfileCard(profile);
                    container.appendChild(card);
                });
                document.getElementById('like-btn').disabled = false;
                document.getElementById('dislike-btn').disabled = false;
                document.getElementById('details-btn').disabled = false;
            } else {
                 const quote = loveQuotes[Math.floor(Math.random() * loveQuotes.length)];
                container.innerHTML = `<div class="swipe-card" id="no-more-profiles-card"><h3>No more profiles</h3><p>Check back later for new sparks!</p><hr style="width: 80%; margin: 20px 0; border-color: #444;"><p id="quote-text">"${quote.text}"</p><p id="quote-author">- ${quote.author}</p></div>`;
                document.getElementById('like-btn').disabled = true;
                document.getElementById('dislike-btn').disabled = true;
                document.getElementById('details-btn').disabled = true;
            }
        } else {
            if (container.firstElementChild) {
                container.removeChild(container.firstElementChild);
            }
            const nextProfileIndex = currentProfileIndex + 2;
            if (nextProfileIndex < fetchedProfiles.length) {
                const profile = fetchedProfiles[nextProfileIndex];
                const card = createProfileCard(profile);
                container.appendChild(card);
            }
            if(container.children.length === 0) {
                 const quote = loveQuotes[Math.floor(Math.random() * loveQuotes.length)];
                container.innerHTML = `<div class="swipe-card" id="no-more-profiles-card"><h3>No more profiles</h3><p>Check back later for new sparks!</p><hr style="width: 80%; margin: 20px 0; border-color: #444;"><p id="quote-text">"${quote.text}"</p><p id="quote-author">- ${quote.author}</p></div>`;
                document.getElementById('like-btn').disabled = true;
                document.getElementById('dislike-btn').disabled = true;
                document.getElementById('details-btn').disabled = true;
            } else {
                document.getElementById('like-btn').disabled = false;
                document.getElementById('dislike-btn').disabled = false;
                document.getElementById('details-btn').disabled = false;
            }
        }
    }

    function createProfileCard(profile) {
        const card = document.createElement('div');
        card.className = 'swipe-card';
        card.id = `profile-card-${profile.id}`;
        const profileImages = profile.pictures || [];
        const mainImageUrl = profileImages.length > 0 ? profileImages[0] : 'https://via.placeholder.com/400x550.png?text=No+Image';
        let galleryHTML = '';
        if (profileImages.length > 1) {
            galleryHTML = `<div class="image-counter" id="image-counter-display">1 / ${profileImages.length}</div><div class="card-nav-arrow left" onclick="changeProfileImage(-1, event)">⬅️</div><div class="card-nav-arrow right" onclick="changeProfileImage(1, event)">➡️</div>`;
        }
        const compatibilityHTML = getCompatibilityInsight(profile);
        card.innerHTML = `<img src="${mainImageUrl.replace('/upload/','/upload/w_400,h_550,c_fill,g_face/')}" alt="${profile.name}" id="profile-swipe-image"><div class="card-info"><h3>${profile.name || 'Unknown User'}, ${calculateAge(profile.dob)}</h3><p>${profile.city || 'Unknown Location'}</p>${compatibilityHTML}</div>${galleryHTML}`;
        return card;
    }
    
    async function fetchUsersFromFirestore(filters = {}) { try { const currentUserUID = auth.currentUser ? auth.currentUser.uid : null; if (!currentUserUID) return; const myDoc = await db.collection('users').doc(currentUserUID).get(); if (!myDoc.exists) return; const myData = myDoc.data(); const myBlockedUsers = myData.blockedUsers || {}; let query = db.collection('users'); if (filters.city) { query = query.where('city', '==', filters.city); } const querySnapshot = await query.get(); let allUsers = []; querySnapshot.forEach((doc) => { const userData = doc.data(); const userId = doc.id; if (userId !== currentUserUID && !myBlockedUsers[userId] && !(userData.blockedBy && userData.blockedBy[currentUserUID])) { if (filters.age && calculateAge(userData.dob) > filters.age) { return; } allUsers.push(userData); } }); const myLikesSnapshot = await db.collection('users').doc(currentUserUID).collection('incoming_likes').get(); const likedMeIds = myLikesSnapshot.docs.map(doc => doc.id); fetchedProfiles = allUsers.sort((a, b) => { const aLikesMe = likedMeIds.includes(a.id); const bLikesMe = likedMeIds.includes(b.id); if (aLikesMe && !bLikesMe) return -1; if (!aLikesMe && bLikesMe) return 1; return Math.random() - 0.5; }); currentProfileIndex = -1; loadNextProfile(); } catch (error) { console.error("Error fetching/filtering users: ", error); } }
    function changeProfileImage(direction, event) { event.stopPropagation(); const profile = fetchedProfiles[currentProfileIndex]; if (!profile) return; const profileImages = profile.pictures || []; const totalImages = profileImages.length; if (totalImages <= 1) return; currentProfileImageIndex = (currentProfileImageIndex + direction + totalImages) % totalImages; document.getElementById('profile-swipe-image').src = profileImages[currentProfileImageIndex].replace('/upload/','/upload/w_400,h_550,c_fill,g_face/'); document.getElementById('image-counter-display').textContent = `${currentProfileImageIndex + 1} / ${totalImages}`; }
    function getChatId(uid1, uid2) { return uid1 < uid2 ? `${uid1}_${uid2}` : `${uid2}_${uid1}`; }
    function setupRealtimeListeners() { if (!auth.currentUser) return; const myId = auth.currentUser.uid; if (userListener) userListener(); userListener = db.collection('users').doc(myId).onSnapshot((snapshot) => { if (snapshot.exists) { const oldBlockedCount = Object.keys(userProfile.blockedUsers || {}).length; userProfile = snapshot.data(); blockedUsers = userProfile.blockedUsers || {}; if (oldBlockedCount !== Object.keys(blockedUsers).length) { updateMessagesView(); } populateProfileView(); } }, console.error); if (likesListenerUnsubscribe) likesListenerUnsubscribe(); likesListenerUnsubscribe = db.collection('users').doc(myId).collection('incoming_likes').orderBy("likedAt", "desc").onSnapshot(async (snapshot) => { const likerIds = snapshot.docs.map(doc => doc.id); if (likerIds.length > 0) { try { const newLikerIds = likerIds.filter(id => !incomingLikes.some(like => like.id === id)); if (newLikerIds.length > 0) { const usersSnapshot = await db.collection('users').where(firebase.firestore.FieldPath.documentId(), 'in', newLikerIds).get(); const newLikerProfiles = usersSnapshot.docs.map(doc => doc.data()); incomingLikes = [...incomingLikes, ...newLikerProfiles]; } incomingLikes = incomingLikes.filter(like => likerIds.includes(like.id)); } catch (e) { console.error("Error fetching liker profiles:", e); incomingLikes = []; } } else { incomingLikes = []; } populateLikesView(); updateLikesBadge(snapshot.size); }, console.error); if (matchesListenerUnsubscribe) matchesListenerUnsubscribe(); matchesListenerUnsubscribe = db.collection('users').doc(myId).collection('matches').orderBy("matchedAt", "desc").onSnapshot(async (snapshot) => { const matchProfilesPromises = snapshot.docs.map(doc => db.collection('users').doc(doc.id).get()); const matchProfilesDocs = await Promise.all(matchProfilesPromises); matches = matchProfilesDocs.filter(doc => doc.exists).map(doc => doc.data()); updateMessagesView(); }, console.error); }
    function populateLikesView() { const likesList = document.getElementById('likes-list'); if (!likesList) return; if (incomingLikes.length === 0) { likesList.innerHTML = '<p style="padding: 20px; text-align: center;">No new likes yet. Your profile is out there!</p>'; return; } likesList.innerHTML = ''; incomingLikes.forEach(liker => { if(!liker || !liker.id) return; const initial = liker.name ? liker.name.charAt(0) : 'U'; const avatarContent = liker.pictures && liker.pictures.length > 0 ? `<img src="${liker.pictures[0].replace('/upload/', '/upload/w_50,h_50,c_fill,g_face/')}" alt="${liker.name}">` : initial; const listItem = document.createElement('li'); listItem.className = 'like-item'; listItem.id = `like-item-${liker.id}`; listItem.innerHTML = `<div class="like-item-info"><div class="chat-avatar">${avatarContent}</div><div class="chat-details"><h4>${liker.name}, ${calculateAge(liker.dob)}</h4><p style="text-align: left;">Liked you!</p></div></div><div class="like-item-actions"><button class="decline-like">✕</button><button class="accept-like">✓</button></div>`; listItem.querySelector('.decline-like').onclick = () => handleLikeDecision(liker, false, listItem); listItem.querySelector('.accept-like').onclick = () => handleLikeDecision(liker, true, listItem); listItem.querySelector('.like-item-info').onclick = () => { const profileIndex = fetchedProfiles.findIndex(p => p.id === liker.id); if (profileIndex !== -1) { showProfileDetails(profileIndex); } else { showTemporaryProfileDetail(liker); } }; likesList.appendChild(listItem); }); }
    function updateLikesBadge(count) { const badge = document.getElementById('likes-badge'); if (count > 0) { badge.textContent = count; badge.style.display = 'flex'; } else { badge.style.display = 'none'; } }
    
    function updateMessagesView() { const chatList = document.getElementById('chat-list'); if (!chatList) return; chatList.innerHTML = ''; if (matches.length === 0) { chatList.innerHTML = '<p style="padding: 20px; text-align: center;">No matches yet. Go like some people!</p>'; return; } matches.forEach(match => { if (!match || !match.id) return; const isBlockedByMe = userProfile.blockedUsers && userProfile.blockedUsers[match.id]; const initial = match.name ? match.name.charAt(0) : 'U'; const avatarContent = match.pictures && match.pictures.length > 0 ? `<img src="${match.pictures[0].replace('/upload/','/upload/w_50,h_50,c_fill,g_face/')}" alt="${match.name}">` : initial; const listItem = document.createElement('li'); listItem.className = 'chat-item'; listItem.id = `chat-item-${match.id}`; if (isBlockedByMe) { listItem.classList.add('blocked'); } const chatItemLeft = document.createElement('div'); chatItemLeft.className = 'chat-item-left'; chatItemLeft.innerHTML = `<div class="chat-avatar">${avatarContent}<span id="active-dot-${match.id}" class="active-dot"></span></div><div class="chat-details"><h4>${match.name}</h4><p id="last-message-${match.id}">You matched! Say hi...</p></div>`; if (!isBlockedByMe) { chatItemLeft.onclick = () => openChatWindow(match); } listItem.appendChild(chatItemLeft); if (isBlockedByMe) { const unblockButton = document.createElement('button'); unblockButton.textContent = 'Unblock'; unblockButton.className = 'button button-secondary'; unblockButton.style = 'padding: 6px 12px; font-size: 12px; margin-top: 0;'; unblockButton.onclick = (e) => { e.stopPropagation(); unblockUser(match.id); }; listItem.appendChild(unblockButton); } else { const chatDeleteBtn = document.createElement('div'); chatDeleteBtn.className = 'chat-item-delete-btn'; chatDeleteBtn.innerHTML = '🗑️'; chatDeleteBtn.onclick = (e) => { e.stopPropagation(); confirmDeleteChatForMe(match.id); }; listItem.appendChild(chatDeleteBtn); } chatList.appendChild(listItem); const chatId = getChatId(userProfile.id, match.id); db.collection('chats').doc(chatId).collection('messages').orderBy('timestamp', 'desc').limit(1).onSnapshot(snap => { const lastMsgEl = document.getElementById(`last-message-${match.id}`); if (!lastMsgEl) return; if (isBlockedByMe) { lastMsgEl.textContent = 'You blocked this user.'; lastMsgEl.style.color = 'var(--error-color)'; lastMsgEl.style.fontStyle = 'italic'; } else if (!snap.empty) { const lastMsg = snap.docs[0].data(); const prefix = lastMsg.senderId === userProfile.id ? "You: " : ""; let messageText = lastMsg.text; if (lastMsg.deletedFor && lastMsg.deletedFor[userProfile.id]) { messageText = 'This message was deleted.'; lastMsgEl.style.fontStyle = 'italic'; } else if (messageText.startsWith('[GAME:')) { messageText = "🎮 Game in progress..."; } else if (messageText.startsWith('[STICKER:')) { messageText = "😀 Sticker"; } else if (messageText.length > 30) { messageText = messageText.substring(0, 27) + "..."; } lastMsgEl.textContent = prefix + messageText; lastMsgEl.style.color = 'var(--text-secondary)'; if (!messageText.startsWith('This message')) lastMsgEl.style.fontStyle = 'normal'; } else { lastMsgEl.textContent = 'You matched! Say hi...'; lastMsgEl.style.color = 'var(--text-secondary)'; lastMsgEl.style.fontStyle = 'normal'; } }); }); }
    
    async function openChatWindow(chatPartnerProfile) { if (!chatPartnerProfile || !auth.currentUser) { showAutoHidePopup("Could not find user details.", '😕'); return; } const myId = auth.currentUser.uid; const theirId = chatPartnerProfile.id; currentChattingWith = chatPartnerProfile; document.getElementById('chat-with-name').textContent = currentChattingWith.name; const avatarHeader = document.getElementById('chat-avatar-header'); const profileImages = currentChattingWith.pictures || []; avatarHeader.innerHTML = profileImages.length > 0 ? `<img src="${profileImages[0].replace('/upload/', '/upload/w_40,h_40,c_fill,g_face/')}" alt="${currentChattingWith.name}">` : (currentChattingWith.name ? currentChattingWith.name.charAt(0) : 'U'); const key = `chatBubbleTheme_${myId}_${theirId}`; setBubbleTheme(localStorage.getItem(key) || 'none', false); const messageArea = document.getElementById('message-area'); messageArea.innerHTML = `<div id="icebreaker-suggestion" onclick="useIcebreaker(this)"></div><div id="blocked-user-banner"></div>`; const blockedBanner = document.getElementById('blocked-user-banner'); const chatFooter = document.getElementById('chat-footer'); const isBlockedByMe = userProfile.blockedUsers && userProfile.blockedUsers[theirId]; if (isBlockedByMe) { blockedBanner.innerHTML = `You have blocked ${currentChattingWith.name}. <button id="unblock-in-chat-btn">Unblock</button>`; blockedBanner.style.display = 'block'; chatFooter.style.display = 'none'; document.getElementById('unblock-in-chat-btn').onclick = () => unblockUserInChat(currentChattingWith); } else { blockedBanner.style.display = 'none'; chatFooter.style.display = 'flex'; } const icebreakerDiv = messageArea.querySelector('#icebreaker-suggestion'); icebreakerDiv.textContent = `💡 Icebreaker: "${icebreakerQuestions[Math.floor(Math.random() * icebreakerQuestions.length)]}"`; const chatId = getChatId(myId, theirId); const messagesRef = db.collection('chats').doc(chatId).collection('messages').orderBy('timestamp'); if (chatListenerUnsubscribe) chatListenerUnsubscribe(); chatListenerUnsubscribe = messagesRef.onSnapshot(snapshot => { const unreadMessagesToUpdate = []; if (snapshot.empty && !isBlockedByMe) { icebreakerDiv.style.display = 'block'; } else { icebreakerDiv.style.display = 'none'; } snapshot.docChanges().forEach(change => { const messageData = change.doc.data(); const messageId = change.doc.id; if (change.type === "added") { if (!document.getElementById(`msg-${messageId}`)) { displayMessage(messageId, messageData, false); } if (messageData.senderId !== myId && !messageData.seen) { unreadMessagesToUpdate.push(change.doc.ref); } } else if (change.type === "modified") { const msgWrapper = document.getElementById(`msg-${messageId}`); if (msgWrapper) { displayMessage(messageId, messageData, false, true); } } else if (change.type === "removed") { const msgWrapper = document.getElementById(`msg-${messageId}`); if(msgWrapper) msgWrapper.remove(); } }); if (unreadMessagesToUpdate.length > 0) { const batch = db.batch(); unreadMessagesToUpdate.forEach(msgRef => batch.update(msgRef, { seen: true })); batch.commit().catch(err => console.error("Error batch updating seen status:", err)); } if (snapshot.docChanges().some(c => c.type === 'added')) { setTimeout(() => messageArea.scrollTop = messageArea.scrollHeight, 100); } }, (error) => { console.error("Error in chat listener:", error); showAutoHidePopup("Chat connection error.", '📡'); }); if (onlineStatusListenerUnsubscribe) rtdb.ref(onlineStatusListenerUnsubscribe).off(); if (typingListenerUnsubscribe) rtdb.ref(typingListenerUnsubscribe).off(); const statusEl = document.getElementById('chat-user-status'); const statusRefPath = '/status/' + theirId; const typingRefPath = `/typing/${chatId}/${theirId}`; onlineStatusListenerUnsubscribe = statusRefPath; typingListenerUnsubscribe = typingRefPath; rtdb.ref(statusRefPath).on('value', (snap) => { const status = snap.val(); rtdb.ref(typingRefPath).once('value', typingSnap => { if(typingSnap.val()) { statusEl.textContent = "typing..."; statusEl.style.color = "var(--accent-color)"; } else if(status && status.isOnline) { statusEl.textContent = "Online"; statusEl.style.color = "var(--success-color)";} else { statusEl.textContent = "Offline"; statusEl.style.color = "var(--text-secondary)"; } }); }); rtdb.ref(typingRefPath).on('value', typingSnap => { rtdb.ref(statusRefPath).once('value', statusSnap => { const status = statusSnap.val(); if(typingSnap.val()) { statusEl.textContent = "typing..."; statusEl.style.color = "var(--accent-color)"; } else if(status && status.isOnline) { statusEl.textContent = "Online"; statusEl.style.color = "var(--success-color)"; } else { statusEl.textContent = "Offline"; statusEl.style.color = "var(--text-secondary)"; } }); }); showScreen('chat-screen'); }

    function displayMessage(id, data, useAnimation = false, isUpdate = false) { const messageArea = document.getElementById('message-area'); let wrapper = document.getElementById(`msg-${id}`); if(isUpdate && wrapper) { wrapper.innerHTML = ''; } else if (!wrapper) { wrapper = document.createElement('div'); wrapper.className = 'message-wrapper'; wrapper.id = `msg-${id}`; } const myId = auth.currentUser.uid; if (data.deletedFor && data.deletedFor[myId]) { const deletedDiv = document.createElement('div'); deletedDiv.className = 'message deleted-message'; deletedDiv.textContent = 'This message was deleted'; wrapper.innerHTML = ''; wrapper.appendChild(deletedDiv); addLongPressListener(wrapper, id); } else if (data.text && data.text.startsWith('[STICKER:')) { wrapper.innerHTML = `<span class="sticker-message">${data.text.split(':')[1]}</span>`; if (data.senderId === myId) wrapper.classList.add('outgoing'); else wrapper.classList.add('incoming'); addLongPressListener(wrapper, id); } else if (data.text && data.text.startsWith('[GAME:')) { renderGameUI(wrapper, data.text, data.senderId); addLongPressListener(wrapper, id); } else { const messageDiv = document.createElement('div'); messageDiv.className = 'message'; messageDiv.textContent = data.text; if (data.senderId === myId) { wrapper.classList.add('outgoing'); messageDiv.classList.add('outgoing'); const statusDiv = document.createElement('div'); statusDiv.className = 'message-status'; statusDiv.id = `status-${id}`; statusDiv.innerHTML = data.seen ? '✓✓' : '✓'; if (data.seen) statusDiv.classList.add('seen'); wrapper.innerHTML = ''; wrapper.appendChild(messageDiv); wrapper.appendChild(statusDiv); if (useAnimation) { const inputRect = document.getElementById('message-input').getBoundingClientRect(); const wrapperRect = wrapper.getBoundingClientRect(); wrapper.style.setProperty('--start-x', (inputRect.left - wrapperRect.left) + 'px'); wrapper.style.setProperty('--start-y', (inputRect.top - wrapperRect.top) + 'px'); wrapper.classList.add('fly-in'); } } else { wrapper.classList.add('incoming'); messageDiv.classList.add('incoming'); wrapper.innerHTML = ''; wrapper.appendChild(messageDiv); } addLongPressListener(wrapper, id); } if (!document.getElementById(`msg-${id}`)) { const banner = document.getElementById('blocked-user-banner'); messageArea.insertBefore(wrapper, banner); } }
    
    async function sendMessage(textOverride) {
        const input = document.getElementById('message-input');
        const text = (typeof textOverride === 'string') ? textOverride : input.value.trim();
        if (text && currentChattingWith && auth.currentUser) {
            if (userProfile.blockedUsers && userProfile.blockedUsers[currentChattingWith.id]) {
                showAutoHidePopup("You have blocked this user. Unblock to send messages.", "🚫");
                return;
            }
            const myId = auth.currentUser.uid;
            const tempText = text;
            if (typeof textOverride !== 'string') {
                input.value = '';
                input.focus(); 
                document.getElementById('send-btn').disabled = true;
                handleTyping({target: input});
            }
            const chatId = getChatId(myId, currentChattingWith.id);
            const messagesRef = db.collection('chats').doc(chatId).collection('messages');
            try {
                await messagesRef.add({
                    text: tempText,
                    senderId: myId,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    seen: false,
                    deletedFor: {}
                });
                if (!tempText.startsWith('[GAME:') && !tempText.startsWith('[STICKER:') && userProfile.stats && !(userProfile.stats.conversationsStarted || []).includes(currentChattingWith.id)) {
                    db.collection('users').doc(myId).update({
                        'stats.conversationsStarted': firebase.firestore.FieldValue.arrayUnion(currentChattingWith.id)
                    }).then(() => {
                        if (((userProfile.stats.conversationsStarted || []).length + 1) >= 5) {
                            unlockAchievement('convoStarter');
                        }
                    });
                }
            } catch (error) {
                console.error("Error sending message:", error);
                showAutoHidePopup("Message could not be sent. They may have blocked you.", '❌');
                if (typeof textOverride !== 'string') {
                    input.value = tempText;
                    document.getElementById('send-btn').disabled = false;
                }
            }
        }
    }

    async function permanentlyDeleteMessage(msgId) { if (!msgId || !auth.currentUser) return; const chatId = getChatId(auth.currentUser.uid, currentChattingWith.id); const msgRef = db.collection('chats').doc(chatId).collection('messages').doc(msgId); try { await msgRef.delete(); } catch(error){ console.error("Error permanently deleting message:", error); } }
    
    async function executeMismatch() { if (!currentChattingWith || !auth.currentUser) return; const myId = auth.currentUser.uid; const theirId = currentChattingWith.id; try { const batch = db.batch(); batch.delete(db.collection('users').doc(myId).collection('matches').doc(theirId)); batch.delete(db.collection('users').doc(theirId).collection('matches').doc(myId)); await batch.commit(); showAutoHidePopup(`You have mismatched with ${currentChattingWith.name}.`, '💔'); if (document.getElementById('chat-screen').classList.contains('active')) { showScreen('main-app-screen'); showView('messages-view'); } } catch (error) { console.error("Error during mismatch:", error); showAutoHidePopup("Could not mismatch. Please try again.", "⚙️"); } }
    
    function confirmMismatch() { if (!currentChattingWith) return; toggleChatMenu(false); showCustomConfirm( 'Confirm Mismatch', `<p>Are you sure you want to mismatch with ${currentChattingWith.name}? This will permanently remove them from your matches and delete the chat history. This action cannot be undone.</p>`, '💔', () => { executeMismatch(); } ); }
    function confirmDeleteChatForMe(userId) { if(!userId) return; showCustomConfirm( 'Delete Chat', `<p>Are you sure you want to delete this chat history? This will only remove it for you.</p>`, '🗑️', () => { deleteChatForMe(userId); } ); }
    
    async function deleteChatForMe(userId) { if (!userId || !auth.currentUser) return; const myId = auth.currentUser.uid; const chatId = getChatId(myId, userId); const messagesRef = db.collection('chats').doc(chatId).collection('messages'); showAutoHidePopup('Deleting chat...', '🗑️'); try { const batch = db.batch(); const snapshot = await messagesRef.get(); snapshot.forEach(doc => { batch.update(doc.ref, { [`deletedFor.${myId}`]: true }); }); await batch.commit(); showAutoHidePopup('Chat deleted for you.', '✅'); } catch (error) { console.error("Error deleting chat for me:", error); } }

    function reportCurrentUser() { if (!currentChattingWith) return; const reason = prompt(`Please provide a reason for reporting ${currentChattingWith.name}:`); if (reason && reason.trim() !== '') { db.collection('reports').add({ reportedUserId: currentChattingWith.id, reportedBy: userProfile.id, reason: reason.trim(), timestamp: firebase.firestore.FieldValue.serverTimestamp() }).then(() => { showAutoHidePopup('User has been reported. Thank you.', '🛡️'); toggleChatMenu(false); }).catch(error => { console.error("Error reporting user: ", error); showAutoHidePopup('Could not submit report.', '❌'); }); } }
    async function blockUser() { if (!currentChattingWith) return; if (confirm(`Are you sure you want to block ${currentChattingWith.name}? You won't be able to chat with them.`)) { const myId = auth.currentUser.uid; const theirId = currentChattingWith.id; try { const batch = db.batch(); const myRef = db.collection('users').doc(myId); const theirRef = db.collection('users').doc(theirId); batch.update(myRef, { [`blockedUsers.${theirId}`]: true }); batch.update(theirRef, { [`blockedBy.${myId}`]: true }); await batch.commit(); showAutoHidePopup(`${currentChattingWith.name} has been blocked.`, '🚫'); toggleChatMenu(false); if (document.getElementById('chat-screen').classList.contains('active')) { openChatWindow(currentChattingWith); } } catch (error) { console.error("Error blocking user:", error); showAutoHidePopup("Could not block user. Please try again.", "⚙️"); } } }
    async function unblockUser(userIdToUnblock) { if (!auth.currentUser || !userIdToUnblock) return; if (!confirm("Are you sure you want to unblock this user?")) return; const myId = auth.currentUser.uid; try { const batch = db.batch(); const myRef = db.collection('users').doc(myId); const theirRef = db.collection('users').doc(userIdToUnblock); batch.update(myRef, { [`blockedUsers.${userIdToUnblock}`]: firebase.firestore.FieldValue.delete() }); batch.update(theirRef, { [`blockedBy.${myId}`]: firebase.firestore.FieldValue.delete() }); await batch.commit(); showAutoHidePopup('User unblocked.', '🤝'); await populateBlockedUsersList(); } catch (error) { console.error("Error unblocking user:", error); showAutoHidePopup("Could not unblock user. Please try again.", "⚙️"); } }
    async function unblockUserInChat(profileToUnblock) { await unblockUser(profileToUnblock.id); const blockedBanner = document.getElementById('blocked-user-banner'); const chatFooter = document.getElementById('chat-footer'); if(blockedBanner) blockedBanner.style.display = 'none'; if(chatFooter) chatFooter.style.display = 'flex'; }
    function openBlockedUsersModal() { const modal = document.getElementById('blocked-users-modal'); modal.classList.add('active'); populateBlockedUsersList(); toggleSideMenu(); }
    async function populateBlockedUsersList() { const listContainer = document.getElementById('blocked-users-list'); listContainer.innerHTML = '<p>Loading...</p>'; const blockedUserMap = userProfile.blockedUsers || {}; const blockedUserIds = Object.keys(blockedUserMap); if (blockedUserIds.length === 0) { listContainer.innerHTML = '<p>You haven\'t blocked anyone.</p>'; return; } try { const userDocsPromises = blockedUserIds.map(id => db.collection('users').doc(id).get()); const userDocs = await Promise.all(userDocsPromises); listContainer.innerHTML = ''; userDocs.forEach(doc => { if (doc.exists) { const blockedProfile = doc.data(); const initial = blockedProfile.name ? blockedProfile.name.charAt(0) : 'U'; const avatarContent = blockedProfile.pictures?.length > 0 ? `<img src="${blockedProfile.pictures[0].replace('/upload/', '/upload/w_40,h_40,c_fill,g_face/')}" alt="${blockedProfile.name}">` : initial; const item = document.createElement('div'); item.className = 'blocked-user-item'; item.innerHTML = `<div class="blocked-user-info"><div class="chat-avatar" style="width: 40px; height: 40px;">${avatarContent}</div><span>${blockedProfile.name}</span></div><button class="button button-secondary" style="padding: 6px 12px; font-size: 12px; margin-top: 0;">Unblock</button>`; item.querySelector('button').onclick = () => unblockUser(blockedProfile.id); listContainer.appendChild(item); } }); } catch (error) { console.error("Error populating blocked list:", error); listContainer.innerHTML = '<p>Could not load blocked users.</p>'; } }
    function toggleChatMenu(show) { const menu = document.getElementById('chat-side-menu'); const overlay = document.getElementById('chat-menu-overlay'); if (show) { menu.classList.add('open'); overlay.classList.add('active'); } else { menu.classList.remove('open'); overlay.classList.remove('active'); } }
    function openChatThemeSelector() { const grid = document.getElementById('chat-theme-grid'); const modal = document.getElementById('chat-theme-selector-modal'); grid.innerHTML = ''; bubbleThemes.forEach(theme => { const item = document.createElement('div'); item.className = 'chat-theme-item'; item.onclick = () => setBubbleTheme(theme.id); let swatchStyle = 'background-color: #333;'; if (theme.colors.length > 0) { swatchStyle = `background: linear-gradient(45deg, ${theme.colors.join(', ')});`; } item.innerHTML = `<div class="theme-swatch" style="${swatchStyle}"></div>${theme.name}`; grid.appendChild(item); }); modal.classList.add('active'); toggleChatMenu(false); }
    function closeChatThemeSelector() { const modal = document.getElementById('chat-theme-selector-modal'); if (modal) { modal.classList.remove('active'); } }
    
    function createBubble(theme) {
        const bubbleBackground = document.getElementById('bubble-background');
        if (!bubbleBackground) return;
        const bubble = document.createElement('div');
        bubble.className = 'bubble';
        const size = Math.random() * 40 + 10;
        const duration = Math.random() * 8 + 10;
        const drift = (Math.random() - 0.5) * 60;
        const color = theme.colors[Math.floor(Math.random() * theme.colors.length)];
        bubble.style.width = `${size}px`;
        bubble.style.height = `${size}px`;
        bubble.style.left = `${Math.random() * 100}vw`;
        bubble.style.animationDuration = `${duration}s`;
        bubble.style.setProperty('--drift', `${drift}px`);
        if (color) {
            bubble.style.backgroundColor = color;
            bubble.style.setProperty('--glow-color', color);
        }
        bubbleBackground.appendChild(bubble);
        setTimeout(() => { bubble.remove(); }, duration * 1000);
    }

    function showAutoHidePopup(message, icon = '❤️') { const popup = document.getElementById("auto-hide-popup"); if (!popup) return; document.getElementById('popup-icon').textContent = icon; document.getElementById('popup-text').textContent = message; popup.classList.add("show"); setTimeout(function(){ popup.classList.remove("show"); }, 2500); }
    function copyProfileId() { if (userProfile.displayId) { unlockAchievement('sharer'); if(navigator.clipboard && window.isSecureContext) { navigator.clipboard.writeText(userProfile.displayId).then(() => showAutoHidePopup('Profile ID copied!', '📋')).catch(err => { showCustomAlert('Could not copy', 'Your ID is: ' + userProfile.displayId); }); } else { showCustomAlert('Could not copy', 'Your ID is: ' + userProfile.displayId); } } }
    function copyReferralCode() { if (userProfile.referralCode) { if(navigator.clipboard && window.isSecureContext) { navigator.clipboard.writeText(userProfile.referralCode).then(() => showAutoHidePopup('Referral Code copied!', '🔗')).catch(err => { showCustomAlert('Could not copy', 'Your Referral Code is: ' + userProfile.referralCode); }); } else { showCustomAlert('Could not copy', 'Your Referral Code is: ' + userProfile.referralCode); } } }
    function toggleSideMenu() { document.getElementById('side-menu').classList.toggle('open'); }
    function toggleThemeModal() { document.getElementById('theme-modal').classList.toggle('open'); }
    function changeTheme(themeClass) { document.body.className = ''; document.body.classList.add(themeClass); }
    function showFlirtLines() { const flirtModal = document.getElementById('flirt-modal'); changeFlirtLine(); flirtModal.classList.add('active'); }
    function changeFlirtLine() { currentFlirtLine = flirtLines[Math.floor(Math.random() * flirtLines.length)]; document.getElementById('flirt-line-display').textContent = currentFlirtLine; }
    function hideFlirtModal() { document.getElementById('flirt-modal').classList.remove('active'); }
    function handleFlirtChoice(accepted) { const copyButton = document.getElementById('copy-flirt-btn'); if (accepted) { if(navigator.clipboard && window.isSecureContext) { navigator.clipboard.writeText(currentFlirtLine).then(() => { copyButton.textContent = '✓ Copied!'; showAutoHidePopup("Copied to clipboard!", '📋'); setTimeout(() => { hideFlirtModal(); copyButton.textContent = '✓ Jaisa tum chaho...'; }, 1000); }); } else { showCustomAlert('Could not copy', 'Here is the line:<br><i>' + currentFlirtLine + '</i>'); hideFlirtModal(); } } else { hideFlirtModal(); } }
    
    async function findById() {
        const idToFind = document.getElementById('filter-id').value.trim();
        if (!idToFind) {
            showAutoHidePopup("Please enter a Profile ID.", '🆔');
            return;
        }
        try {
            const querySnapshot = await db.collection('users').where('displayId', '==', idToFind).limit(1).get();
            if (querySnapshot.empty) {
                showAutoHidePopup("User not found with that ID.", '😕');
            } else {
                const foundProfile = querySnapshot.docs[0].data();
                fetchedProfiles = fetchedProfiles.filter(p => p.id !== foundProfile.id);
                fetchedProfiles.unshift(foundProfile);
                document.getElementById('swipe-card-container').innerHTML = '';
                currentProfileIndex = -1;
                loadNextProfile();
                toggleSideMenu();
                showView('home-view');
                showAutoHidePopup("User found! Now at the top of your stack.", '🎉');
            }
        } catch (error) {
            console.error("Error finding user by ID:", error);
            showAutoHidePopup("An error occurred while searching.", '⚙️');
        }
    }

    async function applyFilters() { const city = document.getElementById('filter-city').value.trim(); const age = document.getElementById('filter-age').value; const filters = {}; if (city) { filters.city = city; } if (age) { filters.age = parseInt(age); } toggleSideMenu(); showFilterAppliedModal(); await fetchUsersFromFirestore(filters); }
    function showFilterAppliedModal() { document.getElementById('filter-modal').classList.add('active'); }
    function hideFilterAppliedModal() { document.getElementById('filter-modal').classList.remove('active'); }
    
    function editProfile() { 
        document.getElementById('name').value = userProfile.name || ''; 
        document.getElementById('email').value = userProfile.email || ''; 
        document.getElementById('mobile').value = userProfile.mobile || ''; 
        document.getElementById('dob').value = userProfile.dob || ''; 
        document.getElementById('gender').value = userProfile.gender || 'Woman'; 
        document.getElementById('city').value = userProfile.city || ''; 
        document.getElementById('state').value = userProfile.state || ''; 
        document.getElementById('bio').value = userProfile.bio || ''; 
        document.getElementById('prompt1').value = userProfile.prompt1 || ''; 
        document.getElementById('prompt2').value = userProfile.prompt2 || ''; 
        document.getElementById('prompt3').value = userProfile.prompt3 || ''; 
        document.getElementById('height').value = userProfile.height || ''; 
        document.getElementById('religion').value = userProfile.religion || ''; 
        document.getElementById('homeTown').value = userProfile.homeTown || ''; 
        document.getElementById('workplaceCity').value = userProfile.workplaceCity || ''; 
        document.getElementById('education').value = userProfile.education || 'High School'; 
        document.getElementById('profession').value = userProfile.profession || ''; 
        document.getElementById('drinking').value = userProfile.drinking || 'Yes'; 
        document.getElementById('smoking').value = userProfile.smoking || 'Yes'; 
        document.getElementById('diet').value = userProfile.diet || 'Vegetarian'; 
        document.getElementById('profile-vibe').value = userProfile.vibe || 'default'; 
        document.querySelectorAll('#hobbies-profile .hobby-tag').forEach(tag => tag.classList.toggle('selected', (userProfile.hobbies || []).includes(tag.textContent))); 
        document.querySelectorAll('#interests-details .hobby-tag').forEach(tag => tag.classList.toggle('selected', (userProfile.interests || []).includes(tag.textContent))); 
        document.querySelectorAll('#language-tags .hobby-tag').forEach(tag => tag.classList.toggle('selected', (userProfile.languages || []).includes(tag.textContent))); 
        document.querySelectorAll('.zodiac-item').forEach(sign => sign.classList.toggle('selected', userProfile.zodiac === sign.textContent)); 
        updateProfilePicsPreview(); 
        const finalButton = document.getElementById('final-onboarding-btn'); 
        finalButton.textContent = 'Save Changes'; 
        finalButton.onclick = saveProfileChanges; 
        showScreen('details-screen'); 
    }

    function showCustomAlert(title, text, icon = '❤️') { const modal = document.getElementById('custom-alert-modal'); modal.classList.add('active'); const titleEl = document.getElementById('custom-alert-title'); const textEl = document.getElementById('custom-alert-text'); const iconEl = document.getElementById('custom-alert-icon'); const actionsEl = document.getElementById('custom-alert-actions'); const closeBtn = document.getElementById('custom-alert-close-btn'); titleEl.textContent = title; textEl.innerHTML = text; iconEl.innerHTML = icon; actionsEl.innerHTML = `<button class="button" onclick="document.getElementById('custom-alert-modal').classList.remove('active')">OK</button>`; const closeAction = () => modal.classList.remove('active'); actionsEl.querySelector('button').onclick = closeAction; closeBtn.onclick = closeAction; }
    function showCustomConfirm(title, text, icon, onConfirm) { const modal = document.getElementById('custom-alert-modal'); modal.classList.add('active'); document.getElementById('custom-alert-title').textContent = title; document.getElementById('custom-alert-icon').innerHTML = icon; document.getElementById('custom-alert-text').innerHTML = text; const actionsEl = document.getElementById('custom-alert-actions'); actionsEl.innerHTML = `<button class="button button-secondary" id="custom-confirm-cancel">Cancel</button><button class="button" id="custom-confirm-ok">OK</button>`; document.getElementById('custom-confirm-ok').onclick = () => { modal.classList.remove('active'); onConfirm(); }; document.getElementById('custom-confirm-cancel').onclick = () => modal.classList.remove('active'); document.getElementById('custom-alert-close-btn').onclick = () => modal.classList.remove('active'); }
    function showTemporaryProfileDetail(profile) { document.getElementById('profile-detail-name').textContent = `${profile.name}'s Profile`; populateDetailViewContent(profile); showScreen('profile-detail-screen'); }
    function populateDetailViewContent(profile) { const container = document.getElementById('profile-detail-content'); container.className = 'view-content'; if (profile.vibe) { container.classList.add(`vibe-${profile.vibe}`); } let picsHTML = ''; if (profile.pictures && profile.pictures.length > 0) { picsHTML = '<h4>Pictures</h4><div class="avatar-grid">'; profile.pictures.forEach(url => { picsHTML += `<img src="${url.replace('/upload/', '/upload/w_150,h_150,c_fill,g_face,r_8/')}" style="width: 100px; height: 100px; object-fit: cover; border-radius: 8px;">`; }); picsHTML += '</div>'; } const personalityVibe = profile.quizResult ? `<div class="vibe-badge">Their Vibe: ${profile.quizResult}</div>` : ''; container.innerHTML = ` ${personalityVibe} <h4>User ID</h4><p style="text-align: left; font-family: monospace;">${profile.displayId || 'N/A'}</p><h4>Bio</h4><p style="text-align: left;">${profile.bio || 'No bio provided.'}</p>${profile.prompt1 ? `<h4>My simple pleasures...</h4><p style="text-align: left;">${profile.prompt1}</p>` : ''}${profile.prompt2 ? `<h4>I'm looking for...</h4><p style="text-align: left;">${profile.prompt2}</p>` : ''}${profile.prompt3 ? `<h4>My perfect Sunday...</h4><p style="text-align: left;">${profile.prompt3}</p>` : ''}${picsHTML}<h4>Details</h4><ul style="list-style-type: none; padding-left: 0;"><li><strong>Age:</strong> ${calculateAge(profile.dob)}</li>${profile.zodiac ? `<li><strong>Zodiac:</strong> ${profile.zodiac}</li>` : ''}${profile.height ? `<li><strong>Height:</strong> ${profile.height}</li>` : ''}${profile.religion ? `<li><strong>Religion:</strong> ${profile.religion}</li>` : ''}${profile.homeTown ? `<li><strong>Home Town:</strong> ${profile.homeTown}</li>` : ''}${profile.workplaceCity ? `<li><strong>Workplace:</strong> ${profile.workplaceCity}</li>` : ''}${(Array.isArray(profile.languages) && profile.languages.length > 0) ? `<li><strong>Languages:</strong> ${profile.languages.join(', ')}</li>` : ''}${profile.education ? `<li><strong>Education:</strong> ${profile.education}</li>` : ''}${profile.profession ? `<li><strong>Profession:</strong> ${profile.profession}</li>` : ''}${profile.drinking ? `<li><strong>Lifestyle:</strong> ${profile.drinking} drinker, ${profile.smoking} smoker.</li>` : ''}${profile.diet ? `<li><strong>Diet:</strong> ${profile.diet}</li>` : ''}</ul><h4>Hobbies</h4><p style="text-align: left;">${(Array.isArray(profile.hobbies) && profile.hobbies.length > 0) ? profile.hobbies.join(', ') : 'No hobbies listed.'}</p><h4>Interests</h4><p style="text-align: left;">${(Array.isArray(profile.interests) && profile.interests.length > 0) ? profile.interests.join(', ') : 'No interests listed.'}</p>`; }
    async function showProfileDetails(index = -1) { let profile; if (index !== -1 && index < fetchedProfiles.length) { profile = fetchedProfiles[index]; } else if (currentProfileIndex >= 0 && currentProfileIndex < fetchedProfiles.length) { profile = fetchedProfiles[currentProfileIndex]; } else { return; } document.getElementById('profile-detail-name').textContent = `${profile.name}'s Profile`; populateDetailViewContent(profile); showScreen('profile-detail-screen'); }
    function populateExploreView() { const grid = document.getElementById('explore-grid'); if (!grid) return; grid.innerHTML = ''; if (fetchedProfiles.length === 0) { grid.innerHTML = '<p>No profiles to explore. Check back later!</p>'; return; } const exploreProfiles = fetchedProfiles.filter(p => !matches.some(m => m.id === p.id)); exploreProfiles.forEach((profile) => { const card = document.createElement('div'); card.className = 'explore-card'; card.onclick = () => { const originalIndex = fetchedProfiles.findIndex(p => p.id === profile.id); showProfileDetails(originalIndex); }; const imageUrl = profile.pictures && profile.pictures.length > 0 ? profile.pictures[0].replace('/upload/', '/upload/w_200,h_240,c_fill,g_face/') : 'https://via.placeholder.com/200x240.png?text=No+Image'; card.innerHTML = `<img src="${imageUrl}" alt="${profile.name}"><div class="explore-card-info">${profile.name}, ${calculateAge(profile.dob)}</div>`; grid.appendChild(card); }); }
    const dailyTips = [ "Ask open-ended questions to keep the conversation flowing. Instead of 'Did you have a good day?', try 'What was the best part of your day?'.", "A genuine compliment goes a long way. Focus on their personality, sense of humor, or intelligence.", "Be yourself! The right person will appreciate you for who you are.", "Shared experiences build bonds. Suggest an activity you both enjoy for a first date.", "Listen more than you talk. Showing you're interested in their stories is very attractive." ];
    const sparkQuizzes = [ { question: "Your ideal date night is:", options: ["A fancy dinner", "A cozy movie night", "An outdoor adventure", "A lively concert"], result: "This shows what kind of atmosphere you find romantic!" }, { question: "What's most important in a partner?", options: ["Sense of Humor", "Ambition", "Kindness", "Spontaneity"], result: "Knowing your priorities helps you find a better match." }, { question: "A dream vacation would be:", options: ["Relaxing on a beach", "Exploring a historic city", "Hiking in the mountains", "A luxurious resort stay"], result: "Your travel style says a lot about your personality!" } ];
    let currentQuizIndex = 0;
    async function initializeSparksView() { const tipText = document.getElementById('spark-tip-text'); const dayOfYear = Math.floor((new Date() - new Date(new Date().getFullYear(), 0, 0)) / (1000 * 60 * 60 * 24)); tipText.textContent = dailyTips[dayOfYear % dailyTips.length]; currentQuizIndex = dayOfYear % sparkQuizzes.length; loadSparkQuiz(); showRandomDateIdea(); }
    function loadSparkQuiz() { const quiz = sparkQuizzes[currentQuizIndex]; document.getElementById('spark-quiz-question').textContent = quiz.question; const optionsContainer = document.getElementById('spark-quiz-options'); const resultContainer = document.getElementById('spark-quiz-result'); optionsContainer.innerHTML = ''; optionsContainer.style.display = 'block'; resultContainer.innerHTML = ''; quiz.options.forEach(optionText => { const option = document.createElement('div'); option.className = 'spark-option'; option.textContent = optionText; option.onclick = () => handleQuizAnswer(quiz.result); optionsContainer.appendChild(option); }); }
    function handleQuizAnswer(result) { document.getElementById('spark-quiz-options').style.display = 'none'; const resultContainer = document.getElementById('spark-quiz-result'); resultContainer.innerHTML = `<p>${result}</p><button class="button button-secondary" style="margin-top:10px; font-size:12px; padding: 8px 12px;" onclick="resetQuiz()">Take Quiz Again</button>`; }
    function resetQuiz() { document.getElementById('spark-quiz-options').style.display = 'block'; document.getElementById('spark-quiz-result').innerHTML = ''; }
    function getProfileCompletionPercentage(profile) { if (!profile) return 0; let score = 0; const fields = ['name', 'pictures', 'dob', 'gender', 'city', 'state', 'bio', 'height', 'religion', 'homeTown', 'workplaceCity', 'languages', 'education', 'profession', 'drinking', 'smoking', 'diet', 'hobbies', 'interests', 'prompt1', 'prompt2', 'prompt3', 'quizResult']; fields.forEach(field => { const value = profile[field]; if (value && (typeof value !== 'string' || value.trim() !== '') && (!Array.isArray(value) || value.length > 0)) { if (field === 'pictures' && value.length > 0) score++; else if (field !== 'pictures') score++; } }); return Math.round((score / fields.length) * 100); }
    function checkProfileCompletion() { const percentage = getProfileCompletionPercentage(userProfile); const progressBar = document.getElementById('profile-progress-bar'); if (progressBar) { progressBar.style.width = percentage + '%'; progressBar.textContent = percentage + '%'; } if (percentage === 100) { unlockAchievement('profilePro'); } }
    function checkAllAchievements(profile) { if (!profile || !profile.stats || !profile.achievements) return; if (getProfileCompletionPercentage(profile) === 100) unlockAchievement('profilePro'); if (profile.pictures?.length >= 4) unlockAchievement('picturePerfect'); if (profile.prompt1 && profile.prompt2 && profile.prompt3) unlockAchievement('openBook'); if (profile.bio && profile.bio.length > 200) unlockAchievement('thePoet'); }
    function checkReferralAchievements(profile) { if (!profile?.stats?.referralCount) return; const count = profile.stats.referralCount; if (count >= 5) unlockAchievement('friendBringer'); if (count >= 10) unlockAchievement('partyStarter'); if (count >= 20) unlockAchievement('socialite'); if (count >= 50) unlockAchievement('influencer'); if (count >= 100) unlockAchievement('communityBuilder'); if (count >= 500) unlockAchievement('legend'); }
    function updateAchievements() { const grid = document.querySelector('.achievements-grid'); if (!grid || !userProfile.achievements) return; grid.innerHTML = ''; for (const key in achievementsList) { const achievement = achievementsList[key]; const isUnlocked = userProfile?.achievements?.[key] === true; const item = document.createElement('div'); item.className = `achievement-item ${isUnlocked ? 'unlocked' : ''}`; item.innerHTML = `<div class="badge-icon">${achievement.icon}</div><p>${achievement.title}</p>`; grid.appendChild(item); } }
    function useIcebreaker(element) { unlockAchievement('iceBreaker'); const question = element.textContent.replace('💡 Icebreaker: "', '').slice(0, -1); document.getElementById('message-input').value = question; document.getElementById('send-btn').disabled = false; document.getElementById('message-input').focus(); sendMessage(); }
    async function unlockAchievement(achievementKey) { if (!userProfile?.id || !userProfile?.achievements || userProfile.achievements[achievementKey] === true) { return; } userProfile.achievements[achievementKey] = true; updateAchievements(); showAutoHidePopup(`Achievement Unlocked: ${achievementsList[achievementKey].title}!`, achievementsList[achievementKey].icon); try { await db.collection('users').doc(userProfile.id).update({ [`achievements.${achievementKey}`]: true }); const unlockedCount = Object.values(userProfile.achievements).filter(v => v === true).length; if (unlockedCount >= 15) { unlockAchievement('unstoppable'); } } catch (err) { console.error(`Error saving achievement '${achievementKey}' to Firestore:`, err); userProfile.achievements[achievementKey] = false; updateAchievements(); } }
    function showAchievementsInfo() { let infoHTML = '<div>'; for (const key in achievementsList) { const achievement = achievementsList[key]; infoHTML += `<div class="achievement-info-item"><div class="badge-icon">${achievement.icon}</div><div><h4 style="margin:0; text-align:left;">${achievement.title}</h4><p style="text-align:left; max-width:none; font-size: 13px;">${achievement.rule}</p></div></div>`; } infoHTML += '</div>'; showCustomAlert('How to Get Achievements', infoHTML, '🏅'); }
    
    function setBubbleTheme(themeId, showNotif = true) {
        unlockAchievement('themeChanger');
        clearInterval(bubbleInterval);
        const bubbleBackground = document.getElementById('bubble-background');
        if (bubbleBackground) bubbleBackground.innerHTML = '';
        const selectedTheme = bubbleThemes.find(t => t.id === themeId);
        if (selectedTheme && selectedTheme.type !== 'none') {
            for (let i = 0; i < 15; i++) {
                setTimeout(() => createBubble(selectedTheme), Math.random() * 500);
            }
            bubbleInterval = setInterval(() => createBubble(selectedTheme), 350);
            if(showNotif) showAutoHidePopup(`${selectedTheme.name} theme applied!`, '✨');
        } else {
            if(showNotif) showAutoHidePopup('Chat background reset.', '🎨');
        }
        if (auth.currentUser && currentChattingWith) {
            const key = `chatBubbleTheme_${auth.currentUser.uid}_${currentChattingWith.id}`;
            localStorage.setItem(key, themeId);
        }
        closeChatThemeSelector();
    }

    async function setupPresenceSystem() { if (!auth.currentUser) return; const myId = auth.currentUser.uid; const userStatusDatabaseRef = rtdb.ref('/status/' + myId); const isOfflineForRTDB = { isOnline: false, last_changed: firebase.database.ServerValue.TIMESTAMP }; const isOnlineForRTDB = { isOnline: true, last_changed: firebase.database.ServerValue.TIMESTAMP }; rtdb.ref('.info/connected').on('value', (snapshot) => { if (snapshot.val() === false) { return; }; userStatusDatabaseRef.onDisconnect().set(isOfflineForRTDB).then(() => { userStatusDatabaseRef.set(isOnlineForRTDB); }); }); }
    function handleTyping(e) { const input = e.target; document.getElementById('send-btn').disabled = input.value.trim() === ''; if (!currentChattingWith || !auth.currentUser) return; const myId = auth.currentUser.uid; const chatId = getChatId(myId, currentChattingWith.id); const typingRef = rtdb.ref(`/typing/${chatId}/${myId}`); if (input.value.trim().length > 0) { typingRef.set(true); clearTimeout(typingTimeout); typingTimeout = setTimeout(() => { typingRef.set(false); }, 2000); } else { clearTimeout(typingTimeout); typingRef.set(false); } }
    
    function addLongPressListener(element, msgId) {
        const startPress = (e) => {
            const target = e.target;
            if (target.tagName === 'BUTTON' || target.tagName === 'INPUT' || target.classList.contains('game-statement-option')) {
                return;
            }
            e.preventDefault();
            pressedMessageId = msgId;
            longPressTimer = setTimeout(() => {
                const targetElement = document.getElementById(`msg-${pressedMessageId}`);
                const isAlreadyDeleted = targetElement && targetElement.querySelector('.deleted-message');

                if (isAlreadyDeleted) {
                    showCustomConfirm(
                        "Permanent Deletion",
                        "<p>Permanently remove this message stub from the chat? This action cannot be undone and will remove it from view completely.</p>",
                        "🗑️",
                        () => { permanentlyDeleteMessage(pressedMessageId); }
                    );
                } else {
                    showDeleteModal();
                }
            }, 800);
        };
        const endPress = () => clearTimeout(longPressTimer);
        element.addEventListener('mousedown', startPress);
        element.addEventListener('touchstart', startPress);
        element.addEventListener('mouseup', endPress);
        element.addEventListener('mouseleave', endPress);
        element.addEventListener('touchend', endPress);
    }
    
    function showDeleteModal() { const modal = document.getElementById('message-delete-modal'); modal.classList.add('active'); document.getElementById('delete-for-me-btn').onclick = () => { deleteMessageForMe(); modal.classList.remove('active'); }; document.getElementById('delete-for-everyone-btn').onclick = () => { deleteMessageForEveryone(); modal.classList.remove('active'); }; }
    async function deleteMessageForMe() { if (!pressedMessageId || !auth.currentUser) return; const myId = auth.currentUser.uid; const chatId = getChatId(myId, currentChattingWith.id); const msgRef = db.collection('chats').doc(chatId).collection('messages').doc(pressedMessageId); try { await msgRef.update({ [`deletedFor.${myId}`]: true }); showAutoHidePopup('Message deleted for you.', '🗑️'); } catch (error) { console.error("Error deleting for me:", error); } }
    async function deleteMessageForEveryone() { if (!pressedMessageId) return; const chatId = getChatId(auth.currentUser.uid, currentChattingWith.id); const msgRef = db.collection('chats').doc(chatId).collection('messages').doc(pressedMessageId); try { await msgRef.delete(); showAutoHidePopup('Message deleted for everyone.', '🗑️'); } catch(error){ console.error("Error deleting for everyone:", error); } }
    function showRandomDateIdea() { const display = document.getElementById('date-idea-display'); const idea = dateIdeas[Math.floor(Math.random() * dateIdeas.length)]; display.textContent = `"${idea}"`; }
    function startCompatibilityQuiz(profile = null) { if(profile) { userProfile = {...userProfile, ...profile}; } currentCompatibilityQuizIndex = 0; compatibilityQuizAnswers = {}; showScreen('compatibility-quiz-screen'); displayCompatibilityQuestion(); }
    function displayCompatibilityQuestion() { if (currentCompatibilityQuizIndex >= compatibilityQuiz.length) { finishCompatibilityQuiz(); return; } const progress = (currentCompatibilityQuizIndex / compatibilityQuiz.length) * 100; document.getElementById('compatibility-progress-bar').style.width = `${progress}%`; const q = compatibilityQuiz[currentCompatibilityQuizIndex]; document.getElementById('compatibility-question-text').textContent = q.question; const optionsContainer = document.getElementById('compatibility-question-options'); optionsContainer.innerHTML = ''; Object.entries(q.options).forEach(([type, text]) => { const optionDiv = document.createElement('div'); optionDiv.className = 'question-option'; optionDiv.textContent = text; optionDiv.onclick = () => { compatibilityQuizAnswers[type] = (compatibilityQuizAnswers[type] || 0) + 1; currentCompatibilityQuizIndex++; displayCompatibilityQuestion(); }; optionsContainer.appendChild(optionDiv); }); }
    async function finishCompatibilityQuiz() { const scores = compatibilityQuizAnswers; let maxScore = 0; let personalityVibe = 'Explorer'; for (const type in scores) { if (scores[type] > maxScore) { maxScore = scores[type]; personalityVibe = type; } } userProfile.quizAnswers = scores; userProfile.quizResult = personalityVibe; showScreen('questionnaire-screen'); displayQuestion(); }
    function getCompatibilityInsight(otherProfile) { if (!userProfile.quizResult || !otherProfile.quizResult) return ''; if (userProfile.quizResult === otherProfile.quizResult) { return `<div class="compatibility-insight">✨ You're both ${userProfile.quizResult}s! You'll have lots in common.</div>`; } const myAnswers = userProfile.quizAnswers; const theirAnswers = otherProfile.quizAnswers; let sharedInterests = []; if (myAnswers && theirAnswers) { for(const key in myAnswers) { if(theirAnswers[key]) { sharedInterests.push(key.toLowerCase()); } } } if (sharedInterests.length > 0) { return `<div class="compatibility-insight">💡 You both share a love for ${sharedInterests.join(' & ')} things.</div>`; } return `<div class="compatibility-insight">🤔 You are a ${userProfile.quizResult}, they are a ${otherProfile.quizResult}. Explore your differences!</div>`; }
    
    const stickerData = {
        Happy: ['😊','😂','😍','🥳','😁','😄','🤩','🤗','😇','😉','😋','😌','😎','😬'],
        Sad: ['😢','😭','😞','💔','😔','😟','😕','😩','😫','😨','😥','🤕','🥺','🙍'],
        Love: ['❤️','😘','🥰','💕','💞','💓','💖','💘','❤️‍🔥','🫶','😍','💑','💌','👩‍❤️‍💋‍👨'],
        LOL: ['🤣','💀','😹','🤪','😆','😝','😂','😜','😂','🤪','👻','🤡',' Bhoot '],
        Angry: ['😠','😤','😡','🤬','😒','😑','🤨','🙄','👿','👺','🗯️','💢','😣','😠'],
        Shock: ['😮','🤯','😱','😲','😳','😵','🙀','💥','‼️','⁉️','🥴','🤪','😵‍💫','🤢'],
        'Hi-Bye': ['👋','✌️','🙏','👍','👌','✋','🤚','🙌','🤙','🤟','🤝','🫂','🫡','👋'],
        Cute: ['🥺','🐶','🐻','✨','😇','🐰','🦊','🐼','🐨','🐥','🙈','🙉','🙊','💖'],
        Foodie: ['🍕','🍔','☕','🍰','🍿','🍩','🍪','🍦','🍜','🍣','🌮','🍓','🍉','🥑'],
        Celeb: ['🤔','👀','🤫','🤷','🤯','💅','✨','🔥','💯','🙏','😏','👑','🧐','🚶']
    };
    
    function toggleStickerPanel() {
        const panel = document.getElementById('sticker-panel');
        if(panel.style.display === 'block') {
            panel.style.display = 'none';
        } else {
            panel.style.display = 'block';
            if (document.getElementById('sticker-tabs').innerHTML === '') {
                populateStickerPanel();
            }
        }
    }

    function populateStickerPanel() {
        const tabsContainer = document.getElementById('sticker-tabs');
        const gridContainer = document.getElementById('sticker-grid');
        tabsContainer.innerHTML = '';
        gridContainer.innerHTML = '';

        Object.keys(stickerData).forEach((category, index) => {
            const tab = document.createElement('div');
            tab.className = 'sticker-tab';
            tab.textContent = category;
            tab.dataset.category = category;
            tab.onclick = () => showStickerCategory(category);
            tabsContainer.appendChild(tab);

            const content = document.createElement('div');
            content.id = `sticker-content-${category}`;
            content.className = 'sticker-content';
            
            stickerData[category].forEach(sticker => {
                const item = document.createElement('div');
                item.className = 'sticker-item';
                item.innerHTML = `<span>${sticker}</span>`;
                item.onclick = () => sendSticker(sticker);
                content.appendChild(item);
            });
            gridContainer.appendChild(content);

            if (index === 0) {
                showStickerCategory(category);
            }
        });
    }

    function showStickerCategory(category) {
        document.querySelectorAll('.sticker-tab').forEach(t => t.classList.remove('active'));
        document.querySelector(`.sticker-tab[data-category="${category}"]`).classList.add('active');
        document.querySelectorAll('.sticker-content').forEach(c => c.classList.remove('active'));
        document.getElementById(`sticker-content-${category}`).classList.add('active');
    }

    function sendSticker(stickerEmoji) {
        sendMessage(`[STICKER:${stickerEmoji}]`);
        toggleStickerPanel();
    }
    
    function openGameSelection() { document.getElementById('game-selection-modal').classList.add('active'); }
    function sendGameRequest(gameType) { document.getElementById('game-selection-modal').classList.remove('active'); sendMessage(`[GAME:REQUEST:${gameType}]`); }
    function sendGameResponse(response, event) { if(event) event.stopPropagation(); sendMessage(`[GAME:RESPONSE:${response}]`); }
    
    function submitTwoTruths(buttonElement, event) {
        event.stopPropagation();
        const gameContent = buttonElement.closest('.game-content');
        const inputs = gameContent.querySelectorAll('.game-input');
        const statements = Array.from(inputs).map(input => input.value.trim());
        if (statements.some(s => !s)) {
            alert('Please enter all three statements.');
            return;
        }
        const lieIndex = Math.floor(Math.random() * 3);
        const encodedStatements = btoa(JSON.stringify(statements));
        const encodedLieIndex = btoa(lieIndex.toString());
        sendMessage(`[GAME:PLAY:TwoTruths:${encodedStatements}:${encodedLieIndex}]`);
    }

    function renderGameUI(wrapper, messageText, senderId) {
        wrapper.classList.add(senderId === userProfile.id ? 'outgoing' : 'incoming');
        const gameContainer = document.createElement('div');
        gameContainer.className = 'game-message-container';
        const parts = messageText.slice(1, -1).split(':');
        const command = parts[1];
        let html = '';

        try {
            if (command === 'REQUEST') {
                const gameType = parts[2];
                html = `<div class="game-title">🎮 Game Request! 🎮</div><p class="game-instructions">${senderId === userProfile.id ? 'You' : currentChattingWith.name} wants to play ${gameType}.</p>`;
                if (senderId !== userProfile.id) {
                    html += `<button class="button" onclick="sendGameResponse('ACCEPT:${gameType}', event)">Accept</button> <button class="button button-secondary" onclick="sendGameResponse('DECLINE:${gameType}', event)">Decline</button>`;
                }
            } else if (command === 'RESPONSE' && parts.length >= 4) {
                const action = parts[2];
                const gameType = parts[3];
                html = `<div class="game-title">🎮 Game Update 🎮</div>`;
                if (action === 'ACCEPT') {
                    html += `<p class="game-instructions">${senderId === userProfile.id ? 'You' : currentChattingWith.name} accepted the game! Starting now...</p>`;
                    if (senderId === userProfile.id) {
                        setTimeout(() => sendMessage(`[GAME:START:TwoTruths]`), 500);
                    }
                } else {
                    html += `<p class="game-instructions">${senderId === userProfile.id ? 'You' : currentChattingWith.name} declined the game.</p>`;
                }
            } else if (command === 'START' && parts[2] === 'TwoTruths') {
                html = `<div class="game-title">Two Truths, One Lie</div>`;
                if (senderId === userProfile.id) {
                    html += `<p class="game-instructions">${currentChattingWith.name}'s turn! Waiting for them to send their statements.</p>`;
                } else {
                    html += `<p class="game-instructions">Your turn! Enter two truths and one lie about yourself below (the game will decide which is which).</p>
                             <div class="game-content">
                                 <input type="text" class="game-input" placeholder="Statement #1">
                                 <input type="text" class="game-input" placeholder="Statement #2">
                                 <input type="text" class="game-input" placeholder="Statement #3">
                                 <button class="button" onclick="submitTwoTruths(this, event)">Send</button>
                             </div>`;
                }
            } else if (command === 'PLAY' && parts[2] === 'TwoTruths') {
                const statements = JSON.parse(atob(parts[3]));
                const lieData = parts[4]; 
                html = `<div class="game-title">Two Truths, One Lie</div><p class="game-instructions">${senderId === userProfile.id ? 'You sent' : currentChattingWith.name + ' sent'} these statements. Which is the lie?</p>`;
                if (senderId !== userProfile.id) {
                    const shuffledStatements = [...statements].sort(() => Math.random() - 0.5);
                    shuffledStatements.forEach((s) => {
                        html += `<div class="game-statement-option" onclick="sendGameResponse('GUESS:TwoTruths:${btoa(s)}:${parts[3]}:${lieData}', event)">${s}</div>`;
                    });
                } else {
                    statements.forEach(s => { html += `<p style="padding: 5px; text-align: left;">- ${s}</p>`; });
                    html += `<p class="game-instructions">Waiting for ${currentChattingWith.name} to guess...</p>`;
                }
            } else if (command === 'GUESS' && parts[2] === 'TwoTruths') {
                const guessedStatement = atob(parts[3]);
                const originalStatements = JSON.parse(atob(parts[4]));
                const lieIndex = parseInt(atob(parts[5]));
                const correctLie = originalStatements[lieIndex];
                const guesserName = senderId === userProfile.id ? 'You' : currentChattingWith.name;
                const isCorrect = (guessedStatement === correctLie);

                html = `<div class="game-title">Two Truths, One Lie Result</div><p class="game-instructions">${guesserName} guessed that "${guessedStatement}" was the lie.</p>`;
                if (isCorrect) {
                    html += `<h3 style="color:var(--success-color)">Correct! 🎉</h3>`;
                } else {
                    html += `<h3 style="color:var(--error-color)">Incorrect! 😔</h3><p class="game-instructions">The real lie was: "${correctLie}"</p>`;
                }
            }
        } catch(e) {
            console.error("Error rendering game UI:", e, messageText);
            html = "<p>A game error occurred.</p>";
        }
        
        gameContainer.innerHTML = html;
        wrapper.appendChild(gameContainer);
    }

    let currentTutorialPage = 0;
    const tutorialContent = {
        en: [
            { title: 'Welcome to Your Adventure! 🚀', text: "Hey there, Spark Seeker! Welcome to Soul Spark, where great connections begin. Let's take a quick, fun tour to get you started on finding your perfect match. It's super easy and fun, we promise! 😉" },
            { title: 'The Home Screen: Your Discovery Zone 🔭', text: "This is where the magic happens! 🪄 You'll see profiles of other awesome users here. Think of it as a gallery of potential sparks. Take your time, and see who catches your eye. Remember, everyone here is looking for a connection, just like you." },
            { title: 'Swipe & Decide: The Heart of the App ❤️', text: "It's decision time! See someone you like? Swipe RIGHT or tap the ✓ button. It's like saying, 'Hey, I think you\'re cool!'. Not feeling the vibe? No problem! Swipe LEFT or tap the ✕ button. Your choice is always private until it's a mutual match!" },
            { title: 'Dig Deeper: The "Get to Know" Button 🕵️', text: "Curiosity is a good thing! Before you swipe, you can tap the '🎁 Get to know' button. This will show you their full profile: more photos, their bio, prompts, hobbies, and everything they've shared. It's the best way to make an informed decision!" },
            { title: 'It\'s a Match! Let the Sparks Fly ✨', text: "BOOM! When someone you liked also likes you back, you get a MATCH! 🥳 This is where the real fun begins. Your new match will appear in your 'Chats' tab (the speech bubble icon at the bottom). Don't be shy, go say hi! 👋" },
            { title: 'Chat & Play: More Than Just Talk 💬', text: "Your 'Chats' tab holds all your conversations. But why just talk? You can send fun stickers, change the chat theme, and break the ice by playing a game! When you're in a chat, look for the floating '🎮' button to challenge your match to a fun game like 'Two Truths, One Lie'. It’s a great way to learn about each other!"},
            { title: 'Daily Sparks: Your Daily Dose of Fun 🌟', text: "Feeling stuck? Head over to the 'Sparks' tab (the star icon ⭐). Every day, you'll find a new fun quiz, a creative date idea from our 'Date Idea Jar,' and a helpful tip to make your dating journey smoother and more successful. It's your secret weapon!" },
            { title: 'Your Profile: Be Uniquely You 🎨', text: "Your profile is your story. Make it shine! 🌟 Go to the 'Profile' tab (the person icon) to add pictures, write a killer bio, and answer fun prompts. A complete and genuine profile gets way more attention. This is your chance to show the world how amazing you are!" }
        ],
        hi: [
            { title: 'आपके एडवेंचर में स्वागत है! 🚀', text: "नमस्ते, स्पार्क सीकर! Soul Spark में आपका स्वागत है, जहाँ बेहतरीन कनेक्शन शुरू होते हैं। चलिए एक छोटा और मजेदार टूर करते हैं ताकि आप अपना परफेक्ट मैच ढूंढना शुरू कर सकें। यह बहुत आसान और मजेदार है, वादा रहा! 😉" },
            { title: 'होम स्क्रीन: आपकी खोज की जगह 🔭', text: "सारा जादू यहीं होता है! 🪄 आपको यहाँ दूसरे शानदार यूज़र्स की प्रोफाइल दिखेंगी। इसे संभावित स्पार्क्स की एक गैलरी समझें। अपना समय लें, और देखें कि कौन आपकी नज़र में आता है। याद रखें, यहाँ हर कोई आपकी तरह ही एक कनेक्शन की तलाश में है।" },
            { title: 'स्वाइप और फैसला: ऐप का दिल ❤️', text: "अब फैसले का समय है! कोई पसंद आया? दाईं ओर स्वाइप करें या ✓ बटन पर टैप करें। यह कहने जैसा है, 'अरे, मुझे लगता है कि आप कूल हैं!'। वाइब मैच नहीं हो रही? कोई बात नहीं! बाईं ओर स्वाइप करें या ✕ बटन पर टैप करें। आपकी पसंद हमेशा गुप्त रहती है जब तक कि यह एक आपसी मैच न हो!" },
            { title: 'गहराई से जानें: "Get to Know" बटन 🕵️', text: "जिज्ञासा अच्छी बात है! स्वाइप करने से पहले, आप '🎁 Get to know' बटन पर टैप कर सकते हैं। यह आपको उनकी पूरी प्रोफ़ाइल दिखाएगा: और तस्वीरें, उनका बायो, प्रॉम्प्ट्स, हॉबीज़, और वह सब कुछ जो उन्होंने शेयर किया है। यह एक सूचित निर्णय लेने का सबसे अच्छा तरीका है!" },
            { title: 'मैच हो गया! अब चिंगारी उड़ने दो ✨', text: "बूम! जब कोई जिसे आपने पसंद किया है, वह भी आपको वापस पसंद करता है, तो आपको एक मैच मिलता है! 🥳 यहीं से असली मज़ा शुरू होता है। आपका नया मैच आपके 'चैट' टैब (नीचे स्पीच बबल आइकन) में दिखाई देगा। शरमाएं नहीं, जाकर नमस्ते कहें! 👋" },
            { title: 'चैट और खेल: सिर्फ बातों से बढ़कर 💬', text: "आपके 'चैट' टैब में आपकी सभी बातचीत होती है। लेकिन सिर्फ बातें क्यों? आप मजेदार स्टिकर भेज सकते हैं, चैट की थीम बदल सकते हैं, और गेम खेलकर चुप्पी तोड़ सकते हैं! जब आप चैट में हों, तो अपने मैच को 'Two Truths, One Lie' जैसे मजेदार गेम के लिए चैलेंज करने के लिए फ्लोटिंग '🎮' बटन देखें। यह एक-दूसरे के बारे में जानने का एक शानदार तरीका है!" },
            { title: 'डेली स्पार्क्स: आपका रोज़ का मज़ा 🌟', text: "अटक गए हैं? 'स्पार्क्स' टैब (स्टार आइकन ⭐) पर जाएँ। हर दिन, आपको एक नया मजेदार क्विज़, हमारे 'डेट आइडिया जार' से एक क्रिएटिव डेट आइडिया, और आपकी डेटिंग यात्रा को आसान और अधिक सफल बनाने के लिए एक उपयोगी टिप मिलेगी। यह आपका गुप्त हथियार है!" },
            { title: 'आपकी प्रोफाइल: आप जैसे हैं वैसे रहें 🎨', text: "आपकी प्रोफाइल आपकी कहानी है। इसे चमकाएं! 🌟 तस्वीरें जोड़ने, एक शानदार बायो लिखने, और मजेदार प्रॉम्प्ट्स का जवाब देने के लिए 'प्रोफाइल' टैब (व्यक्ति आइकन) पर जाएं। एक पूरी और सच्ची प्रोफाइल पर बहुत अधिक ध्यान जाता है। यह दुनिया को दिखाने का आपका मौका है कि आप कितने अद्भुत हैं!" }
        ],
        mr: [
            { title: 'तुमच्या साहसात स्वागत आहे! 🚀', text: "नमस्कार, स्पार्क सीकर! Soul Spark मध्ये तुमचे स्वागत आहे, जिथे उत्तम कनेक्शन सुरू होतात. चला एक छोटी आणि मजेदार टूर करूया जेणेकरून तुम्ही तुमचा परफेक्ट मॅच शोधायला सुरुवात करू शकाल. हे खूप सोपे आणि मजेदार आहे, वचन देतो! 😉" },
            { title: 'होम स्क्रीन: तुमची शोधाची जागा 🔭', text: "इथेच खरी जादू घडते! 🪄 तुम्हाला येथे इतर छान वापरकर्त्यांची प्रोफाइल दिसतील. याला संभाव्य स्पार्क्सची गॅलरी समजा. आपला वेळ घ्या आणि बघा की कोण तुमच्या नजरेत भरते. लक्षात ठेवा, येथील प्रत्येकजण तुमच्यासारखाच कनेक्शन शोधत आहे." },
            { title: 'स्वाइप आणि निर्णय: ॲपचे हृदय ❤️', text: "आता निर्णयाची वेळ आली आहे! कोणी आवडले का? उजवीकडे स्वाइप करा किंवा ✓ बटणावर टॅप करा. हे असे म्हणण्यासारखे आहे, 'अरे, मला वाटते की तू कूल आहेस!'. व्हायब जुळत नाहीये? काही हरकत नाही! डावीकडे स्वाइप करा किंवा ✕ बटणावर टॅप करा. तुमची निवड नेहमीच गुप्त राहते जोपर्यंत ते परस्पर मॅच होत नाही!" },
            { title: 'अधिक जाणून घ्या: "Get to Know" बटण 🕵️', text: "जिज्ञासा ही चांगली गोष्ट आहे! स्वाइप करण्यापूर्वी, तुम्ही '🎁 Get to know' बटणावर टॅप करू शकता. हे तुम्हाला त्यांचे संपूर्ण प्रोफाइल दाखवेल: अधिक फोटो, त्यांचे बायो, प्रॉम्प्ट्स, हॉबीज आणि त्यांनी शेअर केलेले सर्व काही. माहितीपूर्ण निर्णय घेण्याचा हा सर्वोत्तम मार्ग आहे!" },
            { title: 'मॅच झाले! आता ठिणग्या उडू द्या ✨', text: "बूम! जेव्हा तुम्हाला आवडलेली व्यक्ती तुम्हालाही पसंत करते, तेव्हा तुम्हाला एक मॅच मिळतो! 🥳 इथूनच खरी मजा सुरू होते. तुमचा नवीन मॅच तुमच्या 'चॅट्स' टॅबमध्ये (खालील स्पीच बबल आयकॉन) दिसेल. लाजू नका, जाऊन हॅलो म्हणा! 👋" },
            { title: 'चॅट आणि खेळ: फक्त बोलण्यापेक्षा बरेच काही 💬', text: "तुमच्या 'चॅट्स' टॅबमध्ये तुमची सर्व संभाषणे आहेत. पण फक्त बोलणे का? तुम्ही मजेदार स्टिकर्स पाठवू शकता, चॅटची थीम बदलू शकता आणि गेम खेळून संभाषण सुरू करू शकता! जेव्हा तुम्ही चॅटमध्ये असाल, तेव्हा तुमच्या मॅचला 'Two Truths, One Lie' सारख्या मजेदार गेमसाठी चॅलेंज करण्यासाठी फ्लोटिंग '🎮' बटण शोधा. एकमेकांना जाणून घेण्याचा हा एक उत्तम मार्ग आहे!" },
            { title: 'डेली स्पार्क्स: तुमचा रोजचा मनोरंजनाचा डोस 🌟', text: "अडकल्यासारखे वाटतेय? 'स्पार्क्स' टॅबवर (स्टार आयकॉन ⭐) जा. दररोज, तुम्हाला एक नवीन मजेदार क्विझ, आमच्या 'डेट आयडिया जार'मधून एक क्रिएटिव्ह डेट आयडिया आणि तुमचा डेटिंग प्रवास अधिक सोपा आणि यशस्वी करण्यासाठी उपयुक्त टीप मिळेल. हे तुमचे गुप्त शस्त्र आहे!" },
            { title: 'तुमचे प्रोफाइल: तुम्ही जसे आहात तसे खास रहा 🎨', text: "तुमचे प्रोफाइल तुमची कहाणी आहे. तिला चमकवा! 🌟 फोटो जोडण्यासाठी, एक छान बायो लिहिण्यासाठी आणि मजेदार प्रॉम्प्ट्सची उत्तरे देण्यासाठी 'प्रोफाइल' टॅबवर (व्यक्ती आयकॉन) जा. पूर्ण आणि अस्सल प्रोफाइलकडे जास्त लक्ष वेधले जाते. तुम्ही किती अद्भुत आहात हे जगाला दाखवण्याची ही तुमची संधी आहे!" }
        ]
    };


    function openTutorial() {
        toggleSideMenu(); 
        currentTutorialPage = 0;
        const lang = localStorage.getItem('tutorialLang') || 'en';
        document.getElementById('tutorial-language-selector').value = lang;
        renderTutorialPage(lang, currentTutorialPage);
        document.getElementById('tutorial-modal').classList.add('active');
    }

    function renderTutorialPage(lang, pageIndex) {
        localStorage.setItem('tutorialLang', lang);
        const content = tutorialContent[lang][pageIndex];
        document.getElementById('tutorial-page-content').innerHTML = `<h3>${content.title}</h3><p>${content.text}</p>`;
        document.getElementById('tutorial-page-counter').textContent = `${pageIndex + 1} / ${tutorialContent[lang].length}`;
        document.getElementById('tutorial-back-btn').disabled = pageIndex === 0;
        document.getElementById('tutorial-next-btn').disabled = pageIndex === tutorialContent[lang].length - 1;
    }

</script>
</body>
</html>
